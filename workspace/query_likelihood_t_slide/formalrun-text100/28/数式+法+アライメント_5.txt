
SQL Server 技術資料
著者
: Jimmy May
、
Denny Lee
寄稿者
: Mike
Ruthruff
、
Robert Smith
、
Bruce Worthington
、
Jeff Goldner
、
Mark Licata
、
Deborah Jones
、
Michael Thomassy
、
Michael Epprecht
、
Frank McBath
、
Joseph Sack
、
Matt Landers
、
Jason McKittrick
、
Linchi Shea
、
Juergen Thomas
、
Emily Wilson
、
John Otto
、
Brent Dowling
テクニカル
レビューアー
: Mike
Ruthruff
、
Robert Smith
、
Bruce Worthington
、
Emily Wilson
、
Lindsey Allen
、
Stuart Ozer
、
Thomas Kejser
、
Kun Cheng
、
Nicholas Dritsas
、
Paul Mestemaker
、
Alexei Khalyako
、
Mike Anderson
、
Bong Kang
発行
:2009 年
5 月
対象
: SQL Server 2008
要約
: 
ディスク
パーティションのアラインメントは、
SQL Server 
のパフォーマンスを向上するのに役立つ強力なツールです。ディスクのパフォーマンスを最適に構成することは、しばしば、科学的でもあり芸術的でもある作業と考えられています。ディスク
パーティションのアラインメントは、重要ながらも見落とされがちなベスト
プラクティスの
1 
つです。
Windows Server 2008 
では特に設定しなくても新しいパーティションを作成するときにアラインメントが試みられますが、以前のバージョンの
Windows 
上に作成されたパーティションにとっては、ディスク
パーティションのアラインメントはまだまだ切り離せないテクノロジです。
このホワイト
ペーパーでは、ストレージがアラインメントされているかどうかによるパフォーマンスの違いと、パーティションがアラインメントされていない場合に
I/O 
パフォーマンスに悪影響を与える理由について説明します。また、分析、診断、修復など、
Windows Server 2003 
上で構成されたストレージのディスク
パーティションのアラインメントや、
Windows Server 2008 
が新しいパーティションのアラインメントに関連する問題を修復しながら、既存のパーティションの構成を変更しないしくみについても説明します。
また、背景情報、実装、ベンダーの考慮事項、
2 
つの重要な相関関係、有効なパーティション開始オフセット、パーティションをアラインメントしてファイル
アロケーション
ユニットのサイズを定義し、ドライブ文字を割り当てるための簡単な手順といったトピックも取り上げます。パーティションのアラインメントが
SQL Server 2008 
に与える影響を示すテスト結果も併せて紹介します。
この資料の
Microsoft Word 
バージョンをダウンロード
できます。
はじめに
ディスクのパフォーマンスを最適に構成することは、しばしば、科学的でもあり芸術的でもある作業と考えられています。しかし、ディスク
パフォーマンスのベスト
プラクティスを理解すれば、パフォーマンスを大きく向上できます。ディスク
I/O 
のパフォーマンスには、ディスクの数、サイズ、速度、ファイル
アロケーション
ユニットのサイズ、ホスト
バス
アダプター
(HBA) 
とファブリック
スイッチの構成、ネットワーク帯域幅、ディスク上、コントローラー上、記憶域ネットワーク
(SAN) 
上のキャッシュ、専用、共有、仮想化のいずれのディスク状態か、
RAID 
のレベル、バス速度、ディスク
I/O 
サブシステムからサーバーへのパス数、すべての構成要素のドライバーのバージョン、
RAID 
ストライプ
サイズ、ワークロードなど、数多くの要因が影響します。
ディスク
パーティションのアラインメントは、重要ながらも見落とされがちなベスト
プラクティスの
1 
つです。
Windows Server® 2008 
オペレーティング
システムでは特に設定しなくても新しいパーティションを作成するときにアラインメントが試みられますが、以前のバージョンの
Windows® 
オペレーティング
システム上に作成されたパーティションにとっては、ディスク
パーティションのアラインメントはまだまだ切り離せないテクノロジです。
サポート案件に共通する根本的原因の
1 
つとして、
Microsoft® SQL Server® 
データベース
ソフトウェアのストレージ構成がベスト
プラクティスに準拠していないことが挙げられます。多くの場合、
Windows
、ストレージ、ディスク
コントローラー、およびキャッシュ
セグメントの境界がアラインメントされていないことが原因です。
パーティションがアラインメントされていないと、パフォーマンスに大きな悪影響が出ることがあります。パーティションが
Windows Server 2008 
より前のバージョンの
Windows 
の
RAID 
ディスク
デバイスに作成されていて、高いパフォーマンスが求められる場合は、ディスク
パーティションをアラインメントすることが要件です。この後説明しますが、
Windows Server 2008 
で作成される新しいパーティションは、開始オフセットが基になる
RAID 
ストライプ
ユニットに
(
高い確率で
) 
揃えられます。
システムに高いパフォーマンスが求められる場合は、代表的なワークロードを使ってテストして、その環境でディスク
パーティションをアラインメントすることが有効かどうかを判断することが不可欠です。
Windows Server 2003 
またはそれ以前のバージョンの
Windows 
の場合、パーティションの作成時に実行しない限り、既定のアラインメントオフセットではパーティションはアラインメントされません。これらのバージョンの
Windows 
の既定では、以前の世代のディスク
コントローラーが使用していたシリンダー
/
ヘッド
/
セクター
(CHS) 
というアドレス指定方式に基づく境界に揃えて、ディスク
パーティションが作成されます。以前のバージョンの
Windows 
で作成された既存のパーティションが
Windows Server 2008 
にアタッチされた場合、そのパーティションの作成時にアラインメントの問題があっても、そのまま維持されます。
このホワイト
ペーパーでは、ストレージがアラインメントされているかどうかによるパフォーマンスの違いと、パーティションがアラインメントされていない場合に
I/O 
パフォーマンスに悪影響を与える理由について説明します。また、分析、診断、修復など、
Windows Server 2003 
上で構成されたストレージのディスク
パーティションのアラインメントや、
Windows Server 2008 
が新しいパーティションのアラインメントに関連する問題を修復しながら、既存のパーティションの構成を変更しないしくみについても説明します。
また、次のトピックについても説明します。
背景情報
実装
ベンダーに関する考慮事項
2 
の重要な相関関係
有効なパーティション開始オフセット
さらに、パーティションをアラインメントして、ファイル
アロケーション
ユニット
サイズを定義し、ドライブ文字を割り当てるための簡単な手順についても紹介します。
適用範囲
ここで説明する情報は、マスター
ブート
レコード
(MBR) 
パーティションのある
Windows 
のベーシック
ディスクとダイナミック
ディスクに適用されます。
GUID 
パーティション
テーブル
(GPT) 
ディスクの詳細については扱っていません。ただし、ディスク
パーティションのアラインメントはベスト
プラクティスの
1 
つなので、最適なパフォーマンスが得られるように次の各ハード
ドライブを構成する場合には必要になります。
MBR 
MBR 
GPT 
GPT 
ダイナミック
ディスクと
GPT 
ディスクのパフォーマンス特性については、
SQL Server Customer Advisory Team Web 
サイト
(www.sqlcat.com
、英語
) 
の今後の発行物で扱う予定です。
背景情報
同じような場面で、
"
パーティションのアラインメント
"
、
"
ディスクのアラインメント
"
、
"
ボリュームのアラインメント
"
、および
"
セクタのアラインメント
" 
といった用語を耳にした方もいるでしょう。ここでは、
"
パーティションのアラインメント
" 
を使用します。
"
パーティションのアラインメント
" 
はあまり耳にしない用語かもしれません。経験豊富なディスク管理者であっても、あまり馴染みがないかもしれません。最初は説明に疑いの目を向けられることもしばしばあります。
このトピックに詳しいエンジニアでも、重要性を過小評価していることがあります。たとえば、パーティションのアラインメントが有効なのは
Microsoft Exchange Server 
に対してだけと考えている方もいます。実は、高いパフォーマンスが要求されるすべてのサーバー、特に
SQL Server 
では、パーティションのアラインメントが重要です。
まず、主な用語とその歴史について説明します。
用語
ディスク
I/O 
の説明に使用されている用語の中には、あいまいで明確に区別されていない用語がたくさんあります。一般的に知られている定義を反映している用語もあれば、そうではない用語もあります。共通の基盤に立ってコミュニケーションすることが重要です。ハード
ドライブには多くの構成要素がありますが、今回の説明で重要な構成要素は「付録」の図
2 
に示しています。同じ付録の図
3 
と図
4 
は、図を使った説明です。
"
ハード
ドライブ
" 
の内部には
"
プラッター
" 
という薄い円盤が
1 
枚以上搭載され、その表面に情報を格納する電子媒体があります。
各プラッターの各面にはたくさんのトラックがあります。プラッターのすべての面上で、同じ直径を持つ同心円上にあるトラックのセットが、
"
シリンダー
" 
を構成します
(
最近のドライブではシリンダーの概念がなくなり、トラックは同心円状に配置されなくなりましたが、語源を知っていると理解しやすくなります
)
。プラッターの各面に、専用の読み取り
/
書き込みヘッドがあります。トラックは、セクターに分割されます。セクターは、ハード
ドライブに対する読み取りや書き込みが可能なデータの最小単位です。これまで、セクターのサイズは
512 
バイトに固定されていましたが、新しいドライブには、
1 KB
、
2 KB
、または
4 KB 
のセクターを使用できるものもあります。
多くのエンジニアは、ファイル
アロケーション
ユニットを
"
クラスター
" 
とも表現します。クラスターのサイズは、オペレーティング
システム
(
またはユーザー
) 
によってパーティションがフォーマットされるときに決定されます。たとえば、ハード
ドライブのセクターが
512 
バイトであれば、
4 KB 
のクラスターには
8 
つのセクターが、
64 KB 
のクラスターには
128 
個のセクターがあります。
"
ストライプ
サイズ
" 
は、
RAID-0
、
RAID-10
、
RAID-5
、または
RAID-6 
のディスク
グループで、すべてのディスクにまたがって存在する
1 
つのストライプ全体のサイズです。ストライプ
ユニット
サイズは、ディスク
グループの各メンバーに格納されるときの、ストライプの各要素のサイズです。ストライプ
サイズは、ストライプ
ユニット
サイズと
RAID 
グループに含まれるディスク数の積です。ストライプ
ユニット
サイズは、管理者が構成可能な
RAID 
ディスク
グループの属性です。ストライプ
ユニットは、各ディスク上でストライプ
ユニット
サイズとまったく同じサイズのビットの集まりです。
説明
最適なアラインメントを行うために必要な簡単な手順に従う際は、パーティションのアラインメントに関する微妙な差異を気にする必要はありません。パーティションのアラインメントを実行する方法の詳細については、この後の「実装」で説明します。
パーティションがアラインメントされていない場合の特徴を簡単に説明します。ディスク
アレイ
ハードウェアは
63 
個の予約済み
(
隠し
) 
セクターがあることを報告し、
Windows 
はそのままこの情報を取り込み、ディスクの先頭パーティションの先頭にこれらのセクターを確保します。マスター
ブート
レコード
(MBR) 
はこのような隠しセクターに存在します。ディスク
ハードウェアから報告された
63 
個の隠しセクターに
Windows 
が準拠していると、ストライプ
ユニット、ディスク
コントローラー、およびキャッシュ
セグメントの境界が揃わなくなります。
Windows XP
、
Windows Server 2003
、およびそれ以前のすべてのバージョンの
Windows 
では、これらの予約済みセクターが根本的な物理境界に揃いません。その結果、
1 
クラスターのユーザー
データが、
RAID 
の複数のストライプ
ユニットにまたがって書き込まれることになります。この操作の影響が
n 
回おきに現れます。この場合の
n 
はファイル
アロケーション
ユニット
(
クラスター
) 
のサイズとストライプ
ユニットのサイズによって異なります。ディスク
コントローラーなどのハードウェアの根本的な物理境界にも揃いません。
ストライプ構成のアレイ全体で、要求が
1 
つ以上のストライプ
ユニットの境界をまたがる場合、アレイ
コントローラーに送られる
1 
回の
I/O 
が複数回の
I/O 
に分けて実行されます。こうした影響が積み重なると、パフォーマンスが大きく低下する可能性があります。試験環境と運用環境での影響の詳細については、この後の「パフォーマンスへの影響」で説明します。
どのような場合にも当てはまる原則があります。つまり、アラインメントされていないと、データのクラスターが物理境界をまたがって書き込まれることになり、意図しない不要な
I/O 
が行われ、パフォーマンスの低下につながります。
ベンダーから明確に推奨事項が示されていない場合は、「重要な相関関係
: 
パーティション
オフセット、ファイル
アロケーション
ユニット
サイズ、およびストライプ
ユニット
サイズ」で説明している相関関係に準拠するパーティション
オフセットを使用します。一般に、有効なパーティション開始オフセットは
64 KB 
です。これは、この値がディスク、コントローラー、およびキャッシュの根本的な物理境界と明らかな相関関係があるためです。他にも有効なパーティション開始オフセットはあります。
Windows Server 2008 
の既定のオフセット値は
1,024 KB 
です。詳細については、この後の「有効なパーティション開始オフセット」で説明します。
Windows 
オペレーティング
システムにおけるパーティションのアラインメント
パーティションのアラインメント動作は、使用している
Windows 
のバージョン、およびパーティションを作成した
Windows 
のバージョンによって異なります。ここからは、
Windows Server 2008
、
Windows Vista® 
オペレーティング
システムと、
Windows Server 2003 
以前の
Windows 
におけるパーティションのアラインメント動作について説明します。
Windows
Server 2008 
と Windows Vista: 新しいパーティション
通常、
Windows
Vista 
と
Windows Server 2008 
では既定でパーティションがアラインメントされます。
4 GB 
を超えるディスクアラインメントの既定値は
1 MB
です。この設定は構成可能で、レジストリの次の場所にあります。
HKLM
\
SYSTEM
\
CurrentControlSet
\
Services
\
VDS
\
Alignment
ただし、
OEM 
がセットアップした製品を入手した場合
(
修復パーティションが付属しているなど
)
、
Windows Server 2008 
が新規インストールされていても、パーティション開始オフセットが望ましくない位置に設定されている事例が確認されています。
オペレーティング
システムのバージョンや種類にかかわらず、新しいパーティションがアラインメントされていることを確認してください。
Windows Server 2008: 
以前に作成されたパーティション
Windows Server 2008 
で新しいパーティションを作成すると、ほとんどの場合、パーティションはアラインメントされます。しかし、以前のバージョンの
Windows 
で作成され、
Windows Server 2008 
にアタッチされたパーティションは、作成時の属性が変更されません。つまり、パーティションを明示的にアラインメントしなければ、これらのパーティションはアラインメントされた状態になりません。
Windows Server 2003 
およびそれ以前
Windows Server 2003 
およびそれ以前のバージョンの
Windows 
で作成されたパーティションは、既定ではアラインメントされません。パーティションを明示的にアラインメントする必要があります。
システム
ドライブ
Windows Server 2008 
より前のバージョンの
Windows 
のシステム
ドライブは、アラインメントできません。さいわい、
SQL Server 
専用コンピューターでのシステム
パーティションに関連するワークロードは、一般に、高いパフォーマンスが要求される
SQL Server 
データベース
ファイルなど、大量の
I/O 
を占有するディスクほど、パーティションがアラインメントされていないことが重要にはなりません。「付録」で説明するように、最近のディスクは独自開発の
"
ブラック
ボックス
" 
になっていて、ディスク
パーティションをアラインメントしても個々のディスクのパフォーマンスは向上しません。しかし、キャッシュの境界がアラインメントされていないことは、依然としてパフォーマンスに影響します。オペレーティング
システムが存在するディスクや、
SQL Server 
のデータ
ファイルとログ
ファイルが存在するディスクなど、すべてのディスクでパフォーマンスのしきい値
(
特にディスクの待ち時間
) 
を超えていないことを確認してください。
Windows Server 2008 
の新規インストールでは、システム
ドライブが既定でアラインメントされます。
仮想ドライブ
仮想ドライブだけでなく、仮想ドライブが存在するホスト
ドライブも、最適なパフォーマンスが得られるようにアラインメントする必要があります。ここで説明するガイドラインは、ゲストとホストの両オペレーティング
システムに当てはまります。
説明
最適なアラインメントを行うために必要な簡単な手順に従う際は、パーティションのアラインメントに関する微妙な差異を気にする必要はありません。パーティションのアラインメントを実行する方法の詳細については、この後の「実装」で説明します。
パフォーマンスへの影響
以下の詳細テストでは、アラインメントすることでディスクの待ち時間とクエリの実行時間の両方が約
30% 
削減されました。
6 
個のアラインメント済みディスクのパフォーマンスは、
8 
個の未アラインメントのディスクに匹敵するか、上回ります。
このテストは、デュアル
コア
3.00 GHz Intel Xeon 
プロセッサー
2 
基、
PERC 5/E 
コントローラー
1 
基、および
8 GB 
の物理
RAM 
を搭載した
DELL PowerEdge 2950 
で行いました。
6 
個または
8 
個のディスク
(SAS DAS 
の
73 GB 15K RPM) 
は、クラスター
サイズが
64 KB 
でストライプ
ユニット
サイズが
64 KB 
の
RAID 10 
で構成しました。
Windows Server 2003 
と
SQL Server 2005 
をインストールし、ユーザーがパフォーマンスのベンチマークに使用していたクエリを実行しました。各テストの前に
DBCC DROPCLEANBUFFERS 
を実行して
SQL Server 
バッファー
キャッシュを消去し、ワークロードの実行に必要なすべてのデータをディスクから読み込むようにしています。
収集したデータは、ディスクの待ち時間、実行時間、およびその他の関連指標です。ディスクの待ち時間の計測には、
PhysicalDisk
および
LogicalDisk
パフォーマンス
オブジェクトの
Avg. Disk Sec/Transfer 
カウンターを使用しました。ディスクの待ち時間は、ディスクのパフォーマンスの基本的な指標です。
テストは単純ですが説得力があります。結果には一貫性があり、有意義なものです。
図
1 
に、この結果を示します。
図
1.
ディスク
パーティションをアラインメントするメリットを示すテスト結果
この結果を分析すると、次のような結論が導き出されます。
ディスクをアラインメントすると、アラインメント前と比較してパフォーマンスが大幅に向上します。測定値から、ディスクの待ち時間と実行時間が
30%
以上向上したことがわかります。
6 個のアラインメント済みディスクのパフォーマンスは、8
個の未アラインメントのディスクに匹敵するか、上回ります。
この図からは、パーティションをアラインメントすることで、スループット
(
バイト
/
秒
) 
が増加し、ディスクのキューが短かくなったことはわかりません。
CPU 
の差は、問題にならない程度でした。
その他の例
他のユーザーで実施されたテストの内容とその結果を次の表にまとめました。これらの結果は包括的なものではありませんが、多種多様なワークロードとハードウェア構成でも、ディスク
パーティションをアラインメントするとパフォーマンスが向上することを実証しています。この表に示す作業のため、ユーザーによって大量のデータが再構成されました。たとえば、ある大手金融企業では、
SharePoint® Services 
をホストしていた
SQL Server 
のディスク
インフラストラクチャを再構築しました。また、ある大手通信企業では、企業全体で数テラバイトものデータを再構築しました。
SQL Server 2008 のためのディスク パーティション アライメント ベスト プラクティス
