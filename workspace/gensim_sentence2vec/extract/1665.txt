
ツイートする
Excel VBAのTipsとしては、かなりの反則だと思います。だって、Excel VBAの機能ではないのですから。
これは、先日作成していたマクロで、どうしてもこの情報が必要になり、あれこれ探していたら偶然見つけたテクニックです。見つけたときに思ったのは「えぇ〜ズルい!」という印象でした(^^;
現在実行しているすべてのソフトを調べるには、タスクマネージャを起動して[アプリケーション]タブを開きます。ここにリストされる「プロセス一覧」をプログラムから取得するには、WindowsのAPIや、WMI(Windows Management Instrumentation)などを使うのが一般的です。この「プロセス一覧」をVBAだけで取得しようというのが今回のテーマです。次のようにやります。
Sub Sample1()
Dim WD, task, n As Long
Set WD = CreateObject("Word.Application")    ''Wordを起動します
For Each task In WD.Tasks                    ''Word VBAのTasksコレクションを調べます
If task.Visible = True Then              ''タスク(プロセス)が実行中だったら
n = n + 1
Cells(n, 1) = task.Name              ''タスクの名前を書き出します
End If
Next
WD.Quit
Set WD = Nothing
End Sub
実行結果と、このときのタスクマネージャは次の通りです。
2行目の「Set WD = CreateObject("Word.Application")」はWordを起動しています。なぜWordが必要かというと、驚くべきことにWordのVBAには現在実行中のタスク一覧を返すTasksコレクションが実装されているからです。正確には、タスクではなく実行中のプロセスでしょうか。本稿では便宜上「タスク」と呼ぶことにします。
なぜWordに!?文章の作成にどう関係してくるのでしょう!?まぁ、Wordについて私は詳しくありませんから、もしかすると何か密接なつながりがあるのかもしれません。いずれにしても、こんなに便利な機能がExcel VBAに実装されていないのはズルい!です(^^;
Tasksコレクションには現在実行中の全タスク(Taskオブジェクト)が含まれますので、For Eachステートメントで取得しています。ただし、実行中の全タスクには、ユーザーが意識しない特別なものも含まれます。それらはWindowsのバックグラウンドで動作しています。そこで、Taskオブジェクト(各プロセス)のVisibleプロパティがTrueかどうかを調べて「実行中」のタスクだけをアクティブシートに書き出しました。
Taskオブジェクトには、いくつかのプロパティやメソッドが用意されています。詳しくはWordのヘルプを呼んでもらうとして(読んでもよくわかりませんけど)、ここでは「もしInternet Explorerが起動していたら終了する」というサンプルを紹介します。まずは、起動しているかどうかを調べてみましょう。
Office TANAKA - Excel VBA Tips[実行中のタスク一覧(非API)]
