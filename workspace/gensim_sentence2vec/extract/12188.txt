
実は先日、初めてWordPressの引っ越しを経験しました。
それも「エックスサーバー」から「エックスサーバー」への引っ越し。
同一レンタルサーバー間の引っ越しは中々レアケースでしょ。
異なるサーバー間での引っ越しならまだしも、同一サーバー間での引っ越しというのはサーバーの仕組みが分かる人なら予想できるかもしれませんが、「サイトが表示されない空白の時間」が生じることになります。
予想はしてたんですけど正しく表示されるまでにかなり時間がかかった…orz
胃がキリキリしたのでメモも兼ねて今回学んだことを紹介してみようと思います。
※専門家じゃないので間違ってたらごめんね!
同一レンタルサーバー間の引越し事例
WordPressを運営する上でとても人気のレンタルサーバーとして
XSERVER(エックスサーバー)というレンタルサービスがあります。
関連:WordPress用レンタルサーバーの選び方 – 5種のサーバー徹底比較
自分でもオススメしている「エックスサーバー」を何故か引っ越す!?
しかも引っ越した先が「エックスサーバー」というなんとも珍妙なケース。
ワケが分からないよ…と声が聞こえてきそうなケースだが
実はこういったケースがごくごく自然に起こりえることがある。
A:サイトの譲渡
要するに…
僕がエックスサーバーで運営しているサイトをAさんに譲る
譲り受けたAさんがエックスサーバーにてサイトを運営する
僕の場合は共同運営していたサイトを完全に譲渡した形でしたが…サイトというのは実は「売り買い」されてたりもします。エックスサーバーは人気サーバー故に「売り手」と「買い手」が同じサーバーを使用することが十分に考えられます。
ドメインとDNSの関係
皆さんが日ごろから利用するインターネット。
どのような仕組みでWEBサイトが見れるかご存知?
簡単に言うと以下のような流れでWEBサイトって見れます。
名前:サイトの「名前・ドメイン」を入力
経路:ドメインを元に「経路・DNS」を経由して「住所・IP」を取得
住所:「住所・IP」を元にデータ保管場所「サーバー」よりWEBデータを取得
例えばYahooジャパンであれば…
ドメイン:http://www.yahoo.co.jp/
ルート:DNSを辿ってIPアドレスを取得
サーバー:http://182.22.59.229/
かなりざっくりと説明するとこんなかんじになっています。
仕組みをガチで理解したい場合は書籍などを参考にした方が良い。
DNSは木構造になっている!?
上記の項でざっくりと説明したドメインとDNSの関係。ドメインからサーバーのIPを取得してくる為のルートでもあるDNSというのは実は木構造のような階層を形成しています。
詳しくはこちらの記事を参考にどうぞ。
参考:日経BP – 日経NETWORK
例えば「お名前.com」にてドメインを取得。
エックスサーバーにて運用する場合を考えてみましょう。
お名前.comによるドメイン取得の意味
例えば次のようなドメインが取得できます。
himazines.com(第2レベル・ドメイン)
.net(第2レベル・ドメイン)
.co.jp(第3レベル・ドメイン)
また他サーバーにて利用するためにネームサーバーの設定を行います。
例えばエックスサーバーなら以下のようなネームサーバー設定ですね。
ネームサーバー1:ns1.xserver.jp
ネームサーバー2:ns2.xserver.jp
ネームサーバー3:ns3.xserver.jp
ネームサーバー4:ns4.xserver.jp
ネームサーバー5:ns5.xserver.jp
要するに…
お名前.comで取得した第2・第3レベルドメインの今後の運用サーバーについてはエックスサーバーのネームサーバーさんに聞いておくれやす～…ということですね。
図にすると以下のようなイメージになります。
エックスサーバーにおけるドメインの扱い
更に…エックスサーバーは複数のサーバーを保有しています。
エックスサーバーの場合は、サーバー1・サーバー2…といったどのサーバーとドメインが対応しているかに関しては自動でDNS設定がされるようになっているはず。※管理画面のドメイン設定を行った際に変更手続きが行われると予想
バリュードメインなどは「DNSレコード/転送URLの変更」という項目から設定することで切りかえることができたりします。
これによって…WEBサイトのデータが保存されている末端である「サーバー」まで行きつくことになります。最終的なサーバーのIPを取得することができるようになるイメージっすね。
himazinesのIPを取得する場合
ルートサーバー・質問:himazines.comのIPは?
ルートサーバー・解答:.comのIPはコチラ
.com管理DNS・質問:himazines.comのIPは?
.com管理DNS・解答:管理先(お名前.comのDNS)のIPはコチラ
お名前.com・質問:himazines.comのIPは?
お名前.com・解答:管理先(エックスサーバーのDNS)のIPはコチラ
エックスサーバー・質問:himazines.comのIPは?
エックスサーバー・解答:IPはx.x.x.xです
こんな感じのフローが出来上がっていると考えられます。
たぶんな!…間違ってても保障はしないぜ～(^ω^;)
実際に引っ越しする場合
今回は以下の二つの引越し事例を紹介してみる。
他サーバーからの引越し
同一サーバー間の引越し
他サーバーからの引越し
お名前.comにて取得したドメインがあったとします。
でもって以下のような引越しのケースを考えます。
引越し前:ロリポップサーバー
引越し後:エックスサーバー
引越し前にお名前.comに設定していたロリポップサーバーのネームサーバーを変更し、新たに引越し後のエックスサーバーのネームサーバーを入力することになります。要は…第2・第3レベルにおけるDNSの変更ってやつですかね。
同一サーバー間の引越し
では次は同一サーバー(サービス)間の引越し。
コチラは末端のエックスサーバー側DNSが変更されます。
※第4レベルと呼んでよいのかな…??
キャッシュとプロパゲーション
ここで登場するのがキャッシュとプロパゲーション。
実はこのIPの問い合わせ作業ですが毎回行われているわけではなく、キャッシュ(一時的に以前のデータを記憶)を用いてIPを返答する仕組みが含まれています。要するにDNSを変更してもすぐに全ての「経路・DNS」に反映されるわけではありません。
画像引用元:プロパゲーション – One Point
画像引用元に詳しく解説されているので興味のある人が見てみるといいかも。要するにアクセス先のIPにズレが生じてしまいます。この現象をプロパゲーションと言います。コレがサーバー移転(DNS変更)した際に生じる問題。
特に同一サーバー間で引っ越した場合は要注意。
エックスサーバーが管理しているサーバーは複数存在しますが、「エックスサーバー・鯖1」にて「example.comのドメイン設定」を行った場合、「エックスサーバー・鯖2」では「example.comのドメイン設定」ができないようにロックがかかります。
「入力されたドメインは既に設定されています」というエラーメッセージが表示されます。みたことある人は少ないのではなかろうか・・・?
エックスサーバーの場合、鯖1から鯖2にサイトを移管しようとした場合、鯖1にてドメインの削除作業を行う必要があるんですけど削除と同時に「自動的にデータが全て末梢」されます。※しかも鯖1のドメイン削除しないと鯖2でドメイン設定・追加ができないため事前準備ができない
要するにプロパゲーションを回避するための本当なら残しておきたかった鯖1のデータが全て消されることになります。これにより、鯖1と鯖2の間でプロパゲーションが発生している間は、403・404エラーが発生し、サイトが表示されない空白の時間が生じます。
…
これが…僕がWordPress引越しの際に胃がキリキリした問題です。
おまけに第2・第3レベルでのDNS変更では無く、末端におけるDNS変更であるため、プロパゲーションの発生時間が長いのな。丸一日以上…サイトが表示されたりされなかったりを繰り返していてマジで胃に穴があきそうだったお(^ω^;)
エックスサーバー間のWordPress引越し手順(メモ)
実はもう一回引越しが発生する可能性があるのでメモ。
エックスサーバー間で引越しする人は作業確認用にどうぞ。
※参考:エックスサーバーマニュアル
準備:引越し前のサーバー
1.WordPressデータのバックアップ
サーバーパネルのバックアップよりtar.gz圧縮データ取得可能。
※FFFTPから取得しても良いが手間なのでサーバーパネルからがオススメ。
2.データベースのバックアップ(エクスポート)
サーバーパネルのphpmyadminを利用。
ログイン時に必要なMySQLのパスワードはwp-config.php内に記述されている。
※パスワードを忘れた人はチェック
準備:引越し後のサーバー
1.データベースを作成
MySQLによるWordPress用データベースはドメイン削除前に移すことが可能。その為、引越し後のサーバーで利用するデータベースは事前に作成しておくのが良い。
2.wp-config.phpの中身を書き変え
新しく作成したデータベースの物に書き変えておく。
3.データベースのインポート
引越し前のサーバーからエクスポートしておいたデータベースを、新たに作成したデータベースにインポートする。インポートできたら事前に表示を確認しておきたい。
いざ引越し
1.引越し前のサーバーにてドメイン削除
削除前にバックアップをもう一度確認。
プロパゲーションが高確率で発生するので事前にサイトで告知しておくのが良い。
引越し後のサーバーでやる作業は事前に試しておくこと。
バックアップが失敗してたら大変なことになるので注意。
MySQLデータは削除されないので…
WordPressデータのバックアップを入念にチェック。
※ドメイン削除と共に削除されてしまうフォルダの名前を一時的に書き変えて削除されないように退避させるのもありかも
2.引越し後のサーバーにてドメイン設定で追加
引越し前のサーバーにてドメイン削除を行うとドメイン設定が可能になる。移管予定のドメインを追加する。
3.動作確認URL設定を行う
エックスサーバーのサーバーパネルにある動作確認URLを追加して、プロパゲーション発生時でも表示確認ができるように準備する。
4.FFFTPなどを利用してWordPressデータをアップロード
階層を間違えないように注意。
wp-config.phpは書き変えたものになっているかチェック。
5.ネームサーバーの変更
必要があればネームサーバーの変更を行う。
※エックスサーバー間の移管なら不要
…
以上。備忘録もこめて。
【同一レンタルサーバー間でのWordPress引越し】DNSとプロパゲーションによる「サイト非表示」問題 | HIMAZINES
