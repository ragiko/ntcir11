
戻り値:
検索一致数を%ERRORLEVEL%にて取得可能
注:ブログの投稿仕様により半角クォーテーション()が全角に変換表示されています
例1:全件表示
GetSchd.exe     (実際はGetSchd32.exeかGetSchd64.exeです、読み替えてください)
例2:タスク名検索
GetSchd.exe /name:”タスク名の一部分”
例3:日時範囲検索 (10時間以内に実行予定のスケジュール数取得)
GetSchd.exe /time:600 
例4:タスク名+日時範囲の両方の条件を満たすもの
GetSchd.exe /name:”タスク名の一部分” /time:600 
例5:表示制御 (検索条件を満たす物のみ表示)
GetSchd.exe /name:”タスク名の一部分” /time:600 /disp:1
例6:ネットワーク
GetSchd.exe /name:”タスク名の一部分” /time:600 /disp:1 /srv:PC名 /usr:ユーザー /pass:パス
例7:24時間分をCSVファイルに出力、表示が不必要な場合は >nul で抑止。
GetSchd.exe /time:1440 /disp:1 /csv:”C:\User\マイ ドキュメント\Data.csv” >nul
※画面表示されたものしか出力しないので /disp:0 ではCSV出力されません。
例8:バッチファイルでの使い方
GetSchd.exe /name:検索文字列 /time:60 /disp:0
echo 検索一致数 = %ERRORLEVEL%
IF %ERRORLEVEL% GTR 0 GOTO FunctionLabel
あまり良い内容でない画像で申し訳ありませんがこんな感じです。
色: 
黄 = 検索一致 (黄色のみが戻り値としてカウントされる)
青 = どれかの検索条件に当てはまる (2つしかないけど)
白 = その他の通常スケジュール
紫 = 検索対象外 ※1
※1  スケジュール本体が無効になっている
またはトリガーがすべて無効になっている
または全トリガーが日時指定ではない ※2
※2 イベント時、アイドル時、ログオン時、等々
トリガーが日時周期で実行される種類ではないの
で「/time:」の日時計算の対象外になる為です
ただし「/name:」のみで検索した場合は例外として
どんなトリガー種類でも検索対象になります
※表示はタスクの有効・無効・イベント種類に関係なく次回予定日時順にソートされます。
ネットワーク越しに他PCのスケジュールを見る場合はRPC(リモートプロシージャコール)が使われます。
*コントロールパネル・管理画面・サービスの中にあるあれです。
RPC自体は通常両方のPCで何も設定しなくても標準状態で動きます。
ただし、相手側PCのFirewallが標準でRPC着信を拒否するはずなので
その辺はFirewallに許可設定しないとRPC通信が動かないでしょう。
まず相手側PCのFirewallをOFFにしてWindows標準のタスク検索コマンドが動くか確認します。
このステップで動かなければUACやRPC環境に問題があるか、標準以外の設定になっているか、
途中のネットワーク経路の設定が不許可になっているのだと思われます。
schtasks.exe /Query /S PC名 /U ユーザー名 /P パス
動くのを確認したら同じように GetSchd32.exe が動くか確認します。
GetSchd32.exe /srv:PC名 /usr:ユーザー名 /pass:パス
問題なく動くのを確認したら相手側PCのファイアウォールを設定して下さい。
標準ファイアウォールだと「スケジュールされたリモートタスク管理」をチェックするだけです。
※WindowsのVersion,エディションによってはリモート管理を許可しないと繋がらないかもしれません。(「コンピュータの管理」から繋いで参照不可ならたぶんそうかと)
どうしても繋ぎたい人はUACと「winrm set /?」辺りを調べるとつながるかもしれません。
機能は検索のみ、更新や削除は「schtasks.exe」を使えばいいので。
自分が必要な機能だけなので検索条件も2個しかありません。
08/28,30, 09/21 更新
09/21  .NET不要版を追加
09/24  .NET不要版を標準ライブラリのみ使用に変更(サイズ減)
09/28  .NET版を廃止。ネットワークオプション追加
2012/1/6  全種類のトリガーで次回実行日時を取れるように機能追加
01/12  CSV出力機能追加
08/28  更新
11/01,27  COMサンプルコード修正(おもにWindows 8用)
12/01  COMメソッド追加
他:スケジューラ操作用COM
ブログで公開しているアプリの「タスクスケジューラ検索」「タスクスケジューラ通知」の
タスクスケジューラ操作部分のコードを抜き出してCOMにしました。
主観ですがタスクスケジューラ自体をアプリやスクリプトから簡単に操作できます。
自由につかってかまいません。
操作は一覧取得・詳細取得・登録・更新・削除・実行・停止・無効・有効が使えます。
こちらはMFC/.NETは未使用なのでランタイムは不要かと思います。
ここでは未解説の説明と誰でもわかるC++/VB/VBScriptサンプル付き一式。
Task Scheduler 2.0 API (later Vista, Server 2008)操作用のラッパーCOMです
SchduleWrap.COM.zip ファイル置き場(SkyDrive)
Schduleのつづりでeが足りないけどプロジェクト作った時に間違えてそのままです
[おわり]
なにげに重要なメモ:
マイクロソフトが用意しているTaskschd.dll はどうも完璧ではなくてバグとまでは言いませんが
トリガー種類が多くて作ってる人が面倒くさくて手抜きでもしたのか、次回実行日時を指して
いる項目「NextRunTime」の値が必ずしも正しい値を保持していない時もあります。
トリガーが1個しかなくても指定のしかたでは値自体が計算されずに空の場合もあります。
ゆえに標準の「schtasks.exe」で取得した値も違っている「場合もあります」。
それでもOSが正しい日時にタスクを起動するのはTaskschd.dll を元にサービス(Schedule)の
方で日時計算する機能が動いているのかな?と想像します。
したがいましてそのチェックと補正ロジックが必要になります、面倒ですが入れました。
例えば、単純に1回動いて終わる様な登録をすると・・・下の画像のように
トリガー上は20:59起動なのに次回実行日時は翌日の23:59と食い違っています。
ちなみに翌日の23:59とはこのトリガーの有効期限の日時です。
(有効期限到来時に自己削除される設定になっています)
正確に言えばタスクスケジューラ本体も画像のように間違った表示をしてます、いつかは修正されるのでしょうか・・・もう数年経ったので予想ではされないと思います。
あとトリガーが複数ある時に無効になったトリガーの予定日が次回実行日時になっている場合もありそれの補正はちょっと面倒で難しい。不要なトリガーは削除するのが一番ですがなんとか取得出来るようにしたつもりです。
Windows 8 のタスクに関するコメント
トリガー値12が1個増えています。でもあまり使わないトリガー種のようなので無視してよいかも?。
APIを使うアプリで登録・更新・削除する際に管理者で実行が必要になるかと思います。
管理者権限は場合によるのかも?。 リモート管理設定と信頼関係設定を正しく行うと
接続先のUACがオンでもWindows7からリモートでWindows8に登録更新削除できています。
操作(アクション)で非推奨となったメール送信とメッセージ表示を選ぶと以下のエラーになります。
APIでメール・メッセージを設定して書き込んでも同様のエラー値が返ってきます。
メトロUIにはメッセージ表示が出ないのとメールの悪用を防ぐ為でしょうか?
Microsoft Task Scheduler 2.0 API に関するコメント
このマイクロソフト提供のAPIの実装はtaskschd.dllで中身はCOMで作られています。
COMですからVBから参照やVBSからCreateObjectで参照して操作できます。 ただ、そのオブジェクト内容はすごい階層構造になっているのでタスク1個の完全な情報を取得しようとするとそれなりの記述量を覚悟しないといけません。 日付等も日付型では取得できません、ただの文字として記録され取得されます。日付型に似た物で期間(Span)を表すものも文字型で記録取得されますので少々変換が必要になります。 COMなのでやり取りは基本バリアント型、文字ならBSTR型、数値はそのまま数値型でいけるのが多いかな。 実際に使ってみればわかりますがとりあえずSDKに合わせて使えるライブラリーは提供しましたって感じの完成度です。使用感は昔の不便な低レベルAPIのような感じでオブジェクト指向っぽい部分が感じられません。
基本的な接続方法から
オブジェクトを作成するとITaskServiceというインターフェイスがありそこに”Connect”メソッドがあります
Connect(サーバー, ユーザー, ドメイン, パス) です。 ここにバリアント型の文字でパラメータを渡します
ローカルPCに接続する場合は各バリアント変数は型が無い初期状態の空を渡します
※セキュリティー上ポリシー設定があればユーザー名とパスワードが必要かもしれません
通常はリモートコンピュータに接続する場合だけ必要なバリアント変数に文字型でセットします
接続1個書いて今更ですが、APIはヘルプやWeb検索すればより正確な情報があると気付きました
MSDNにも今年になってやっとまともなコードサンプルと説明がアップされはじめたようですし、
改めて特筆すべき取得項目についてのみコメントします。
取得項目
コメント
タスク スケジューラ Ver2.0 検索・取得・操作 | @ぐるぐるのスペース
