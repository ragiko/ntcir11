
VDI 環境には、さまざまな設定と構成がありますが、Windows Server 2012 を使用すると VDI 環境をより直接的に管理できます。
Kristin Griffin、Freek Berson
一度稼動すれば、ファーバー ファームの構成と保守は以前よりもはるかに簡単になりました。これは、管理パラダイムにおける根本的な変更による変化です。Windows Server 2008 R2 では、環境を戦術的に管理する必要があり、各サーバーで複数のツールを使用してファームをまとめる必要がありました。また、これらのツールは、目的とする最終結果ではなく、タスクに焦点を当てたものになっていました。
Windows Server 2012 では、仮想デスクトップ インフラストラクチャ (VDI) 環境を戦略的に管理します。どのような結果を導く必要があるかに基づいて変更を加えます。1 つの場所から 1 つのツールを使用して変更を展開します。一部の設定は、グループ ポリシーまたは Windows PowerShell を使用して構成できましたが、今では、グループ ポリシー管理者や Windows PowerShell 専門家でなくても、リモート デスクトップ サービス (RDS) を一元管理することができます。
この記事では、リモート デスクトップ管理サービス (RDMS) の主なセクションについて説明し、RDMS でサーバーのプロパティを分類する方法を説明します。それから、RDMS を使用して VDI セッション ベースの展開を管理する方法に関する例をいくつか紹介します。次回以降の記事では、RDMS を使用して VDI 仮想マシン (VM) ベースの展開を管理する方法についても取り上げます。
RDMS のレイアウト
RDMS には 3 つの主なセクションがあります。
[概要] セクションでは、サーバーに役割サービスを追加または削除して、展開レベルのプロパティを管理します。
[サーバー] セクションでは、環境内の各サーバーの詳細情報や、各サーバーに対して一般的なコンピューターの管理タスクを実行するのに使用するインターフェイスを提供しています。
[コレクション] セクションでは、コレクション固有のプロパティを構成します。
[概要] セクションには、2 つの主な機能があります。1 つ目の機能として、展開した役割サービスに基づく VDI 展開の画像を提供しています。各アイコンを右クリックすると、役割サービスの追加/削除、高可用性 (HA) を実現するための RD 接続ブローカーの構成、新しいセッション コレクションの作成など、対応する実行可能なタスクのメニューが表示されます。2 つ目の機能としては、[タスク] メニューの [展開プロパティの編集] をクリックすることで、展開レベルのプロパティを調整できます。
[サーバー] セクションでは、オンライン状態、IP アドレス、アクティブ化の状態、および最終更新日時を含む各サーバーの概要情報を提供しています。コンピューターの管理 (イベント ビューアー、デバイス マネージャー、およびサービスを含む) にアクセスして各サーバーを管理することもできます。このセクションでは、NIC チーミングの構成、VDI ライセンス問題の診断、Windows PowerShell コマンドの実行、パフォーマンス カウンターの開始、役割や機能の追加/削除、およびサーバーの再起動を行えます。
[コレクション] セクションでは、展開コレクションの詳細を確認したり、セッション コレクションのプロパティ、ホスト サーバー、およびホスト サーバーで実行するユーザー セッションの管理インターフェイスを提供しています。コレクションのメイン ページは、[Collections] (コレクション)、[Host Servers] (ホスト サーバー)、および [Connections] (接続) の 3 つのサブセクションに分かれています。
[Collections] (コレクション) では、セッション コレクションを作成または削除したり、提供する VDI の種類 (セッションまたは VM) や各コレクションで提供しているリソースの種類 (RemoteApp または完全なデスクトップ セッション) を含む、既存のセッション コレクションのプロパティを確認できます。
[Host Servers] (ホスト サーバー) では、全コレクションのすべての RD セッション ホストのサーバーが一覧表示されます。サーバーを右クリックして DRAIN モードにすると、このサーバーへの新しい接続が無効になります。
[Connections] (接続) では、セッション コレクションのホスト サーバーで実行されている全ユーザー セッションが一覧表示されます。ユーザー セッションと対話 (メッセージの送信、ユーザーの切断またはログオフ) するには、ユーザー セッションを右クリックし、ドロップ ダウン メニューから操作を選択します。
各コレクションは、左側ペインのコレクション メイン リンクの下に一覧表示されます。コレクションを選択すると、メイン パネルには、このコレクションだけに適用される管理サブセクションが追加で表示されます。[Host Servers] (ホスト サーバー) サブセクションと [Connections] (接続) サブセクション以外に、次の 2 つの新しいサブセクションが表示されます。
[Properties] (プロパティ) サブセクションでは、[タスク] メニューからセッション コレクション レベルのプロパティを管理できます。
[RemoteApp Programs] (RemoteApp プログラム) サブセクションでは、各 RemoteApp を右クリックして、RemoteApp プログラムを公開/非公開にしたり、RemoteApp プログラムのプロパティを構成したりできます。
RDMS プロパティのカテゴリ
次に、RDMS がこのように構成されている理由を説明しましょう。RDMS では、プロパティを 2 つのカテゴリに分けています (図 1 参照)。
展開レベルのプロパティは、展開に含まれるすべての該当サーバーに影響します (つまり、すべてのコレクションに影響します)。
コレクション レベルのプロパティは、特定のコレクションのサーバーに影響します。
図 1 VDI の設定は展開ベースまたはセッション コレクション ベースで構成する
このカテゴリが重要な理由を理解できていない場合は、次の例を考えてみてください。Windows Server 2008 R2 で、RD セッション ホスト サーバーのファームの 1 つに新しいグループがアクセスできるようにするには、ファーム内の各 RD セッション ホスト サーバーに変更を加える必要がありました。具体的には、[システムのプロパティ] の [リモート] タブに新しいユーザー グループを追加する必要があります。複数ファームのシナリオでは、この作業には時間がかかり、間違えたり、特定のサーバーに変更を加えるのを忘れることがないように祈りましょう。
Windows Server 2012 では、この変更は、セッション コレクション レベルで行います。展開サーバーで RDMS を開き、[Session Collection Properties] (セッション コレクションのプロパティ) セクションの [ユーザー グループ] タブに新しいユーザー グループを追加します。セッション コレクションに含まれる全サーバーでは、新しい設定を早く受け取るようになり、このプロセスではエラーの発生件数が少なくなります。
展開レベルのプロパティ
展開レベルのプロパティを変更するには、概要セクションの [タスク] メニューで [展開プロパティの編集] をクリックします (図 2 参照)。
図 2 [展開プロパティの編集] をクリックして [展開プロパティ] ダイアログ ボックスを開く
[展開プロパティ] ダイアログ ボックスが表示されます。このダイアログ ボックスには、以下のタブでグループ化されたプロパティが表示されます (図 3 参照)。
図 3 展開プロパティはタブ付きの 5 つのセクションにグループ化されている
高可用性: この読み取り専用のセクションは、RD 接続ブローカーが高可用性用に構成されている場合 (または、少なくとも高可性用に準備されている場合) にのみ表示されます。このセクションには、高可性の設定時に指定した値 (データベース接続文字列、データベースの保存場所、DNS ラウンドロビン名) が表示されます。
RD ゲートウェイ: RD ゲートウェイを設定します。RD ゲートウェイは、RD Web アクセスと Remote Area Data Collector (RADC) によって公開される RemoteApps と完全なデスクトップで指定します。
RD ライセンス: リモート デスクトップ ライセンス モードを (サーバーまたはデバイスごとに) 構成して、展開用の RD ライセンス サーバーを追加または削除します。
RD Web アクセス: RD Web アクセス サーバーの内部 DNS 名が読み取り専用で表示され、RD Web アクセスの Web ページへのリンクが表示されます。
証明書: SSL 証明書を一元的に構成できます。3 つの RDS 役割サービス (シングル サインオン (SSO) および署名を実行する RD 接続ブローカー、SSL で暗号化された Web ページを提供する RD Web アクセス、およびインターネット上のリモート デスクトップ プロトコル (RDP) セッションを安全に暗号化およびプロキシする RD ゲートウェイ) で 1 つの証明書が使用されます。これまで証明書の管理は複雑で、多くのツールが必要でしたが、Windows Server 2012 では大幅に簡略化されました。この 3 つの SSL 証明書は、すべて一元的に構成できるようになり、自己署名証明書を作成したり既存の証明書を選択したりすることもできるようになりました。
展開レベルの管理
このしくみを説明するために、RDMS を使用して展開レベルのプロパティを構成する方法について、いくつか例を紹介します。
新しいライセンス サーバーの追加: クイック スタートまたは標準のシナリオ展開では、RD ライセンスの役割はインストールされません。最初の展開後にインストールして追加する必要があります。RDMS の [展開の概要] から、RD ライセンスの役割を展開して、新しいライセンス サーバーを展開に追加できます。
RD ライセンス関連のオプションは、展開プロパティの [RD ライセンス] タブで表示および変更できます。ライセンスの種類 (ユーザーまたはデバイス) を構成し、複数の RD ライセンス サーバーを使用している場合は RD ライセンス サーバーの順序を変更できます。
証明書の構成: VDI 展開では、サーバーの認証、RDP ファイルの署名、RDP トラフィックの暗号化、および SSO の有効化に SSL 証明書を使用しています。これらの証明書は展開全体で比較的簡単にインストールすることが可能で、インストールすると次のタスクが実行できるようになります。
サーバー認証を行う
RDP ファイルにデジタル署名を付与する (RADC や RD Web アクセス経由で発行される RemoteApp と完全なデスクトップの場合)
RD Web アクセス Web サイトへのセキュリティで保護された接続を確立する
RD ゲートウェイ サーバーの ID を確認する
RD ゲートウェイ サーバーとのインターネット トラフィックを暗号化する
SSO を有効にする
RD ゲートウェイと RD Web アクセスを同じサーバーにインストールすると、ワイルドカードや SAN 証明書を使用することなく、1 つの SSL 証明書で、これらのタスクをすべて完了できます。証明書の名前には、展開の外部名を指定する必要があります。この名前は、インターネット上で RD ゲートウェイまたは RD Web アクセス サーバーの外部 IP アドレスに解決できる必要があります。今回の例では、証明書の名前は vdi.virtualkristin.com です。この証明書は、公的証明機関 (CA) から取得したもので、証明書ファイルは展開サーバーに保存しています。
証明書を配布するには、RDMS の展開プロパティを開いて、[証明書] タブを選択します。[RD 接続ブローカー - シングル サインオンを有効にする] を選択します。次に、[既存の証明書の選択] をクリックし、[別の証明書を選択する] を選択します。証明書ファイルを参照し、ファイルにアクセスするのに必要なパスワードを入力して、[接続先コンピューターの信頼されたルート証明機関の証明書ストアに証明書を追加することを許可します] チェック ボックスをオンにし、[適用] をクリックします。後続の 3 つの役割エントリについても同じ処理を実行し、それぞれの構成が完了したら [適用] をクリックします。
各役割サービスのレベルに "信頼済み" と表示されます。証明書のサブジェクト名が役割サービスの一覧のすぐ下に表示されます (図 4 参照)。Windows 7 クライアントで SSO を使用するには、RDP 8 の更新プログラムをインストールして、ローカル グループ ポリシーで有効にする必要があります。
図 4 適切に展開された証明書では、レベルに "信頼済み"、ステータスに "OK" と表示される
コレクション レベルのプロパティ
コレクションのプロパティを変更するには、コレクション プロパティ サブセクションの [タスク] メニューの [プロパティの編集] をクリックします (図 5 参照)。
図 5 [プロパティの編集] をクリックしてコレクション レベルのプロパティを調整する
コレクション プロパティ ダイアログ ボックスが表示されます。このダイアログ ボックスには、次のタブでグループ化されたプロパティが表示されます。
全般: コレクション名、説明、および RD Web アクセスで完全なデスクトップ アイコンを表示するかどうかの設定を変更します。
ユーザー グループ: コレクションに接続できるユーザー グループを選択します。
セッション: 切断されたセッション、アクティブなセッション、およびアイドル セッションの制限時間と、それぞれの制限時間に達した場合の動作を設定します。
セキュリティ: コレクションのセキュリティ層と暗号化レベル、およびネットワーク レベル認証 (NLA) に対応したクライアントからの接続のみ許可するかどうかを構成します。
負荷分散: 物理ハードウェアまたは仮想リソースに基づいて、各セッション コレクション サーバーで連続処理するセッション数を構成します。
クライアント設定: リモート セッションでリダイレクトされるクライアント デバイス (ハード ドライブ、プリンター、クリップボードなど) を構成し、リダイレクトされるモニターの最大数を設定します。
ユーザー プロファイル ディスク: ユーザー プロファイル ディスク (UPD) の場所、最大サイズ、およびファイルとフォルダーの除外を構成します。この UPD は VDI 環境でユーザー エクスペリエンスをカスタマイズする新しい方法と捕らえてください。
セッション コレクション レベルの管理
ここでは、RDMS を使用して VDI 環境のセッション コレクション レベルのプロパティを構成する方法の例をいくつか紹介します。
RD セッション ホスト サーバー負荷分散の調整: ほとんどの環境で、RD セッション ホスト サーバーでは同じリソースを使用し、同じ数のセッションを処理できます。コレクションに物理リソースまたは仮想リソースが異なるサーバーが存在する場合、サーバーで処理できるセッション数を基準にして各サーバーに重みを割り当てる必要があります。重みを割り当てるには、RDMS セッションのコレクション プロパティ ダイアログ ボックスを開き、[負荷分散] を選択します。各サーバーで相対的な重み (0 ～ 100) を選択します。重みの値が大きいと、サーバーでより多くのセッションを処理できることになります。各サーバーで処理する同時セッションの最大数を設定するには、[セッションの最大数] の値を調整します。
ドレイン モードの RD セッション ホスト サーバー: セッション コレクションの RD セッション ホスト サーバーでメンテナンス作業 (サーバーへの修正プログラムの適用やサーバーの再起動など) が必要になることがあります。この作業に備えて、サーバーが新しい接続を受け付けないようにサーバーをドレイン モードに設定します。これを行うには、RDMS でコレクションを選択します。ホスト サーバー セクションで、サーバーを右クリックし、[新しい接続を許可しない] を選択します。
暗号化の調整: RD セッション ホスト サーバーで WAN アクセラレータが機能するように構成する一連の手順には、RD セッション ホスト サーバーの RDP 暗号化を低レベルに設定する手順があります。この設定は、WAN アクセラレータを使用する各コレクションで行います。この設定を行うには、セッション コレクションのプロパティ ダイアログ ボックスを開き、[セキュリティ] を選択して、[暗号化レベル] ボックスの一覧で [低] を選択します。
RDMS を使用して展開を戦略的に管理する方法の説明は以上です。また、VDI プロパティの分類方法、展開レベルとコレクション レベルのプロパティがサーバーに与える影響についても説明しました。それから、SSL 証明書を使用して展開をセキュリティで保護する、新しいライセンス サーバーを追加するなど、RDMS を使用して一般的な管理タスクを実行する方法の例もいくつか紹介しました。
次回の記事では、RD ゲートウェイを展開してインターネット経由で安全に展開にアクセスする方法について説明します。
Kristin Griffin
は、リモート デスクトップ サービスの MVP です。サーバー ベース コンピューティングのコミュニティに役立つマイクロソフト フォーラム (リモート デスクトップ サービス) を運営しており、RDS に関するブログ (blog.kristinlgriffin.com、英語) を公開しています。また、Mark Minasi の著書『Windows Server 2008 パーフェクトガイド』(翔泳社、2010 年) と『Windows Server 2008 R2 パーフェクトガイド』(ソフトバンククリエイティブ、2010 年) の執筆に貢献し、『Microsoft Windows Server 2008 Terminal Services Resource Kit』(Microsoft Press、2008 年) と『Microsoft Windows Server 2008 R2 Remote Desktop Services Resource Kit』(Microsoft Press、2010 年) を Christa Anderson と共同で執筆しました。Microsoft RDS TechNet フォーラムをモデレートし、質問に答えています。
Freek Berson
は、リモート デスクトップ サービスの MVP です。Wortell でインフラストラクチャのスペシャリストとして働いており、デスクトップの仮想化を専門としています。彼のブログは themicrosoftplatform.net (英語) で公開されています。Microsoft TechNet フォーラムをモデレートし、質問に答えています。また、TechNet Wiki の新しいコンテンツを作成しています。
Windows Server 2012: RDMS を使用して RDS を管理する
