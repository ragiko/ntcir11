ペンギンの教科書
ネットワークエンジニアによるIT業界関係者に送る魂の叫び的なブログ。Linux初心者の為の一緒に勉強出来るコンテンツを充実させていきます。監視構築やトラブルシューティングも書いていこうと思います。これから転職する!という方から、ゴッドの域に達してる方まで、学ぶところは学んで、突っ込むところは突っ込んで読んで下さい!
久々のエントリーです。昨今、監視について注目度が増してきています。んが、しかし。 その項目について定義出来ていない人が多すぎる・・・。中には監視屋のHPで堂々と嘘八百を書いている会社もあります。とりあえず監視しとけばよくね?みたいなノリが多くて悲しくなります。監視項目の意味を理解する事で初動の迅速化、的確な対応、障害予測が出来るようになるのに・・・。という訳で、今回は監視項目についてご説明します。要件定義は勿論、基本設計や運用設計でも必ず監視項目は出てきますので、監視運用屋のみならず、インフラ屋の皆さんには知っておいてほしい知識です。よく書いてある監視項目と定義、意味を記載していきます。参考にしていただければ幸いでございます。もちろん、監視定義は定義した者勝ちなので、書類上でしっかり定義を書いていれば問題ありませんが、長年の経験から普通こうだろ?っていうのを書いていきますので抑えておいてください。・死活/ホスト/ノード監視これはサーバの生死を監視します。基本的にはICMP Pingコマンドによる応答を監視します。Ping監視とイコールにされる場合が多いですが、それは適切ではありません。Ping監視は通信遅延を監視するものであって、閾値も300ms〜500ms程度に設定します。この監視はサーバの生死を監視するので、タイムアウトになる値に閾値を設定します。packetlossも基本的には100%が適切な閾値となります。・Ping監視/遅延監視これはサーバへの通信遅延を監視します。基本的にはICMP Pingコマンドで監視しますが、ICMP Tracerouteによる監視手法を取るケースも多く見られます。意味合いとしてはOSI参照モデルの3層がこの監視にあたります。閾値としては応答速度やpacket lossの数/パーセントを設定します。大量トラフィックによる負荷などが基本的にはターゲットとなりますが、意図せず半2重通信になっていてPing監視で気付くなどというレイヤ2を拾うレアパターンもあります。・トラフィック監視これはサーバへの通信量を監視します。snmpを用いてMIBツリーでいうIFMIBで監視される場合が殆どです。サーバへどの程度のトラフィックが発生しているかを確認するのが主な目的です。遅延発生の原因になったり、サーバ負荷増大の原因になる事が多く、サーバの場合は単体で設定するのではなく、リソース監視との併せ技で能力を発揮します。スイッチなどのネットワーク機器では主力になる監視項目です。・リソース監視これはサーバリソースを監視するものです。CPU使用率、Disk使用量、Memory使用量、LoadAverageなどなど。サーバの負荷状況を適切に判断する為に設定します。監視方法は主にsnmpによる監視が主流です。トラフィックもリソース監視に含める人が居ますが、トラフィックは通信量なので単純なサーバリソースではありません。なのでリソース監視に含めるのは適切ではありません。・プロセス/デーモン監視これはサーバ内のプロセス/デーモンを監視します。例えばhttpdのプロセス数なども大きくはこの項目に含まれます。psコマンドで表示されてプロセスとして起動しているものが監視項目です。監視方法としては主にsnmpによる監視が主流ですが、sshでログインしてpsの結果を見て判断するような監視も最近は増えています。Windowsではサービスといわれますが、監視項目としてはプロセス監視にするのが適切です。80番ポートへのアクセスで応答コードを確認してhttpのプロセス監視とするのは適切ではありません。プロセスにより複数のサービスを提供する場合(httpdのhttpとhttpsのように)もありますので、プロセス=サービスと決め付けて監視をするのは不適切となります。・サービス監視これはサーバが提供しているサービスを監視をします。例えば前項のhttp/httpsなどがこの項目に含まれます。他にもpop3、smtp、などTCP/IPプロトコルスイートのアプリケーション(OSI参照モデルの5層以上)がターゲットになります。基本的には応答コードが期待値である事を確認し、サービスが正常に稼動している事を確認する事を意味します。例えばhttpならばGETリクエストを発行して応答コードが期待値(多くは200)を返答する事まで確認します。pop3ならばuserを発行した結果、smtpならばheloを発行して応答コードが期待値になる事を監視すれば上等でしょう。実際にメールを送信して受信を確認するような監視(MailSend)などもサービス監視の一部となります。閾値として応答コードの反応速度が設定されます。反応速度が遅いとユーザ滞在率が悪くなるのも理由の1つです。エンドユーザ側から見た場合に、必要な機能が提供されているかどうかが重要になるため、必然的にアラートが発生した場合はクリティカルとなります。監視方法としてはtelnetを用いる事が多いです。・ポート監視これはサーバが提供しているサービスで使用するポートを監視します。Listen監視などとも呼ばれる場合があります。TCP/UDPの機能、すなわちターゲットはOSI参照モデルの4層がターゲットになります。httpで言えば多くは80番ポート、httpsならば443番ポートに接続出来るかどうかが焦点です。サービス監視は応答コードまで確認しますが、ポート監視はポートがListenしているかどうか、接続出来るかどうか。そこまでを確認します。プロセスが落ちていなければ、基本的にはListen状態は継続されますので、閾値による応答速度監視が主な目的となります。当然サービス監視よりもシビアな応答速度でなければならないのですが、サービス監視と同じ閾値にしている場合が多く、意味のない監視になっているケースが非常に多い項目の1つです。セキュリティポリシー上、プロセス監視が出来ない、またはポートはオープンにしているがコマンドは受け付けないというケースもあります。そういう場合はポート監視を用いる事で、プロセス監視やサービス監視程の精度は無いもののプロセスが起動しているか、エンドユーザが接続出来る環境にあるか無いかは判断する事が可能です。・URL監視これはhttp/httpsに特化した監視になるのですが、主にはVirtualHostの監視です。IPでアクセスするサービス監視では検知出来ない部分を補う意味で使用されます。多く見受けられるのはtomcat等と連携していてIPでは正常なコードが帰ってきてしまう場合。サービス監視はサービスが提供されているかどうかですが、これはさらに細分化された監視です。サービス監視と同意義で使用すると意味合いが変わってきてしまいます。例えばIPアクセスでは正常な応答コード=サービスは正常と判断されますが、実際にurlを叩くとエラーが帰ってきてしまうケースもVirtualHostを設定していると発生します。ロードバランサやLVSなどで使用すると効力をより発揮する監視項目です。・ログ監視サーバ内のログを監視します。messagesは勿論、httpdのログなどありとあらゆるログがログ監視の対象です。基本的にはエージェントによる監視が多く、対象のログファイルをシークしてマッチングした文字列を確認した場合にアラートとして検知される為、マッチング文字列監視などと呼ばれる場合もあります。マッチング文字列監視だとhttpの改竄監視でも使用される為、定義にブレが生じてしまいます。文字列をマッチングさせていたとしても、対象がログならばログ監視とするのが正解です。・snmptrap監視ログ監視と同義で用いられる事が多いのですが全く違います。snmptrapはsnmpエージェントで設定した閾値です。ハードウェア監視と同意でCPU温度やファンスピード等が項目としてあげられます。messagesで検知するハードウェアの障害はログ監視。snmptrapで検知するハードウェアの障害はsnmptrap監視です。多くはサーバ管理エージェント(富士通ならばServerView等)により定義される事が多く、ハードウェアの異常をより早く検知する為に用いられる事が多い監視です。揺れるところとしては、ネットワーク機器等でsyslogへ飛ばしてsyslogで監視する場合はログ監視。snmptrapで飛ばす場合はsnmptrap監視となるところです。これはどちらで監視するかを設計段階で考えて、しっかりと定義しておく事が重要になります。 ひとえに監視といっても沢山の監視項目があります。しっかりと定義しておけば、レイヤで切り分ける事も出来るし、障害検知の段階である程度想像が出来ます。ここまでやる事で初めて監視という意味合いが出てくる訳です。ただ単に意味無く監視を設定しただけではそれは自己満足と同じです。1つ1つ意味を持たせて監視をする事で、サーバ内の挙動を察知する事が出来るわけです。次回は基本的な監視項目と初動について記載していきたいと思います。
監視の項目とは: ペンギンの教科書
