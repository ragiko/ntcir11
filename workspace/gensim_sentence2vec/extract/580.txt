【課題】本発明は、帳票内に存在する押印の文字を正確に認識する帳票認識装置を提供することを目的とする。【解決手段】帳票画像を取得するイメージ入力部と、帳票画像から押印画像を検出する押印画像検出部と、押印色とその他の色とを分離する背景色分離部と、押印画像の傾きを補正する傾き補正部と、文字列を切り出す文字列探索部と、文字列を構成する各文字を切り出す文字切出部と、各文字を認識する文字認識部と、文字列形式に適合する文字認識結果を選択する知識処理部と、文字認識結果と当該文字認識結果の信頼度とに基づいて文字認識結果を棄却するか否かを判定する棄却判定部と、文字認識結果が棄却された場合に、押印画像の文字を再度認識させるか否かを判定するリトライ判定部と、を備えることを特徴とする帳票認識装置。
【発明の詳細な説明】【技術分野】【0001】  本発明は、帳票に存在する文字を認識する帳票認識装置に関し、特に、帳票内に存在する押印の文字も認識する帳票認識装置に関する。【背景技術】【0002】  帳票認識技術は、ユーザが帳票を電子化するために用いられる。この場合には、ユーザは、例えば、一般企業、自治体、金融機関、保険機関、医療機関、及び教育機関等であり、帳票は、例えば、会計伝票、発注書、商品券、納付済通知書、給与報告書、注文書、保険契約書、総合振込書、源泉徴収書、健康診断書、診療報酬明細書、解答用紙、及び入学願書等である。【0003】  帳票認識装置は、帳票から項目(例えば、ID欄、金融機関名欄、金額欄、商品名欄、個数欄、住所欄、及び名前欄等)を探索し、探索した項目に記載された文字を読み取ることによって、項目を電子化する。【0004】  帳票認識装置によって実行される帳票認識処理について図15を用いて説明する。図15は、従来の帳票認識処理の説明図である。【0005】  まず、帳票認識装置は、スキャナ等によって取得された帳票画像データから、各項目の文字列を抽出する。図15では、「支払金額」の文字列「7,890,123」が抽出された場合を例に説明する。【0006】  次に、帳票認識装置は、抽出された文字列から各文字を切り出す。図15では、抽出された文字列が「7」「,」「8」「9」「0」「,」「1」「2」「3」と一文字ごとに切り出される。そして、帳票認識装置は、切り出された各文字を認識することによって、帳票の項目に記載された文字を認識する。図15では、帳票認識装置は、「支払金額」の項目に「7,890,123」が記載されていたことを認識する。【0007】  なお、文字列から各文字を切り出す技術、及び、切り出された各文字を認識する技術は、非特許文献1及び非特許文献2に記載されている。【0008】  帳票画像データから各項目を特定し、特定した項目に記載された文字列を抽出する帳票認識装置が知られている(例えば、特許文献1参照)。【0009】  特許文献1に記載された帳票認識装置について説明する。【0010】  まず、帳票認識装置は、帳票画像データ中の枠を探索する。具体的には、帳票認識装置は、縦罫線及び横罫線を検出し、検出された縦罫線及び横罫線に囲まれた領域を枠として取り出す。次に、帳票認識装置は、取り出した枠内の黒画素を囲む最小矩形を切り出すことによって文字列を抽出する。帳票認識装置は、取り出した枠内の上の枠又は左の枠の文字を認識することによって、抽出された文字列の項目名を認識する。次に、帳票認識装置は、抽出された文字列から各文字を切り出し、切り出された各文字を認識することによって、項目に記載された文字を認識する。【0011】  帳票中に押印が存在するか否かを判定し、押印が存在する場合には、押印の位置及び輪郭を特定する技術が知られている(例えば、特許文献2参照)。また、帳票中の押印の文字を認識するための技術も知られている(例えば、特許文献3参照)。【0012】  帳票中の押印を検出し、押印中の文字を認識する技術は、払込書等において領収印の日付及び機関名等を読み取るために用いられる。例えば、日付と納付期限とを照合することによって、延滞の有無によって帳票を分類する等の目的に用いられる。【先行技術文献】【特許文献】【0013】【特許文献1】特開2007−328820号公報【特許文献2】特開2009−25856号公報【特許文献3】特開平6−111066号公報【非特許文献1】Mohammed Cheriet、Nawwaf Kharma、Cheng lin Liu、Ching Suen、"Character Recognition Systems: A Guide for Students and Practitioners"、Wiley-Interscience、2007年【非特許文献2】石井健一郎、上田修功、前田英作、村瀬洋、「わかりやすいパターン認識」、オーム社出版局、1998年8月【発明の概要】【発明が解決しようとする課題】【0014】  従来の帳票認識装置では、押印の特性が要因となり、押印中の文字列の探索が困難となっていた。押印の特性とは、例えば、帳票内の押印が押印されるべき位置からずれて押印され、帳票の予め印刷されている部分(プレ印刷部分)と重複してしまうこと、押印が傾いてなされること、インクの濃淡によって押印及び押印中の文字にかすれ及びつぶれが発生して、押印及び押印中の文字が劣化してしまうこと、並びに押印のインク及びプレ印刷部分のノイズが押印に混入してしまうこと等である。【0015】  また、押印中の文字がかすれたり、つぶれたりすることによって、帳票認識装置が押印中の文字を認識する精度が悪くなってしまう。【0016】  また、帳票認識装置が押印中の日付を認識する場合には、年月日を区別して、正確に認識する必要がある。ところが、帳票認識装置が年月日の区切り文字であるピリオドを認識することは、インクのかすれ及びノイズ等によって困難となる場合がある。例えば、かすれによって押印中の日付欄のピリオドが消失した場合、「02127」となり、帳票認識装置は、「02.1.27」か「02.12.7」かを区別できない。また、かすれにより、数字の一部が欠けることによって、帳票認識装置は、文字を誤って認識してしまう場合もある。例えば、「7」の上部の横線がかすれによって消失している場合には、帳票認識装置は「1」と誤読してしまう場合がある。以上のように、帳票認識装置が誤って文字を認識することを防止するために、信頼度の低い文字の認識を棄却(不読)する必要がある。【0017】  また、従来の帳票認識技術(例えば、特許文献1)では、帳票内に存在する文字列を切り出すために縦横罫線を用いて矩形枠を探索する。しかし、押印の場合には、押印中の文字が存在する文字領域が矩形枠でない場合、押印が傾いている場合、押印とプレ印刷とが重なっている場合等があり、従来の帳票認識技術を押印の文字認識には適用できない。【0018】  また、従来の押印認識技術(例えば、特許文献2及び特許文献3)は、背景色との分離ができないため、押印とプレ印刷とが重なっている場合には、押印に存在する文字と背景とが重なり、文字の認識が困難となる。また、従来の押印認識技術では、押印の傾きを補正するために、ある方向に射影したヒストグラムを用いるため、押印がかすれている場合には、傾き補正の精度が悪くなってしまったり、種々の方向のヒストグラムを計算するために処理時間がかかるという問題がある。【0019】  また、領収印等の日付認識では、年を示す文字よりも、月及び日を示す文字をより正確に認識することが求められる。これは、応用上、数年前の帳票を混在して認識するケースよりも、同じ年の帳票を認識するケースの方が多いためである。【0020】  以上のように、本発明は、帳票内に存在する押印の文字を正確に認識する帳票認識装置を提供することを目的とする。【課題を解決するための手段】【0021】  本発明の代表的な一例を示せば、帳票を光学的に走査することによって得られた帳票画像を取得するイメージ入力部と、前記イメージ入力部によって取得された帳票画像から押印画像を検出する押印画像検出部と、前記押印画像の輪郭の色を示す押印色とその他の色とを分離する背景色分離部と、前記背景色分離部によって前記押印色が前記その他の色と分離された前記押印画像の傾きを補正する傾き補正部と、前記傾き補正部によって傾きが補正された前記押印画像から文字列を探索し、前記探索された文字列を切り出す文字列探索部と、前記文字列探索部によって切り出された文字列から、前記文字列を構成する各文字を切り出す文字切出部と、前記文字切出部によって切り出された各文字を認識し、前記文字列を構成するすべての文字を認識した結果を示す文字認識結果を算出し、前記認識された各文字の信頼度を算出する文字認識部と、前記文字認識部によって算出された文字認識結果から、予め指定された文字列形式に適合する文字認識結果を選択し、前記選択された文字認識結果に対する信頼度を前記文字認識部によって算出された各文字の信頼度に基づいて算出する知識処理部と、前記知識処理部によって選択された文字認識結果と当該文字認識結果の信頼度とに基づいて、前記知識処理部によって選択された文字認識結果を棄却するか否かを判定する棄却判定部と、前記棄却判定部によって前記文字認識部による文字認識結果が棄却された場合に、押印画像の文字を再度認識させるか否かを判定するリトライ判定部と、を備えることを特徴とする。【発明の効果】【0022】  本発明によれば、帳票内に存在する押印の文字を正確に認識できる。【図面の簡単な説明】【0023】【図1】本発明の第1の実施形態の帳票認識装置の構成図である。【図2】本発明の第1の実施形態の帳票認識装置による帳票認識処理を実行する各モジュールを説明するための図である。【図3】本発明の第1の実施形態の帳票画像データの説明図である。【図4】本発明の第1の実施形態の二値画像データの説明図である。【図5】本発明の第1の実施形態の輪郭画像データの説明図である。【図6】本発明の第1の実施形態の輪郭追跡処理の説明図である。【図7】本発明の第1の実施形態の輪郭追跡処理で交点を算出するために選択された黒画素点の説明図である。【図8】本発明の第1の実施形態の丸印の輪郭の中心と半径とを算出する説明図である。【図9】本発明の第1の実施形態の押印の日付区切り線の説明図である。【図10】本発明の第1の実施形態の文字列探索部によって抽出された文字列の説明図である。【図11】本発明の第1の実施形態の押印が傾き補正された状態の説明図である。【図12】本発明の第2の実施形態の帳票認識装置による帳票認識処理を実行する各モジュールを説明するための図である。【図13】本発明の第2の実施形態の押印認識用辞書の説明図である。【図14】本発明の第2の実施形態の押印テンプレート生成部の押印テンプレート生成処理を実行するための各モジュールの説明図である。【図15】従来の帳票認識処理の説明図である。【発明を実施するための形態】【0024】  以下、本発明の実施形態を図1〜図14を用いて説明する。【0025】  (第1の実施形態)  本発明の第1の実施形態を図1〜図11を用いて説明する。【0026】  本発明の帳票(又は押印)認識装置は、入力された帳票画像から押印を検出し、検出された押印に存在する文字を認識し、文字認識結果によって帳票を分類する。押印が存在する帳票には、例えば、領収印が押印された公共料金等の払込帳票等がある。帳票認識装置が領収印を認識した場合には、例えば、領収印中の日付を認識し、料金払込の延滞の有無等によって帳票を分類する。【0027】  図1は、本発明の第1の実施形態の帳票認識装置の構成図である。【0028】  帳票認識装置101は、入力装置102、表示装置103、イメージ取得装置104、通信装置105、演算装置106、及び外部記憶装置107を備える。【0029】  入力装置102は、演算装置106が実行するプログラムを制御するためのコマンド、及び、帳票認識装置101に接続される外部機器を制御するためのコマンド等を入力するための装置である。入力装置102は、例えば、キーボード又はマウス等である。【0030】  表示装置103は、処理内容等を適宜表示するディスプレイ等である。【0031】  イメージ取得装置104は、スキャナ等のイメージ取得用の装置であり、帳票を光学的に走査することによって帳票画像を取得する。なお、取得した帳票画像等は、外部記憶装置107に記憶される。【0032】  通信装置105は、帳票認識装置101に接続される外部機器(例えば、PCやサーバ等)とデータを通信する。通信装置105は、外部機器からユーザによって入力された実行コマンド、並びに画像及びテキスト等のデータを受信する。また、通信装置105は、帳票認識装置101での処理内容及び帳票認識装置101による帳票認識結果等を外部機器に送信する。【0033】  演算装置106は、CPUであり、帳票を認識する帳票認識処理等を実行する演算装置である。【0034】  外部記憶装置107は、HDD(Hard  Disk  Drive)及びメモリ等の外部記憶装置である。外部記憶装置107には、帳票画像、押印画像、及び押印認識用辞書等の各種データが記憶される。また、外部記憶装置107には、演算装置106によって実行される処理の途中で生成されるデータ等が一時的に記憶される。【0035】  帳票認識装置101は、演算装置106及び外部記憶装置107を少なくとも備えていればよく、入力装置102、表示装置103、イメージ取得装置104、及び通信装置105を備えなくてもよい。【0036】  帳票認識装置101が入力装置102を備えない場合には、外部機器から通信装置105を介して指示されると処理が開始されるようにするか、予め指令された時刻になると自動的に処理が開始されるようにする。【0037】  帳票認識装置101が表示装置103を備えない場合には、帳票認識装置101による処理結果は通信装置105を介して外部機器に送信されるようにするか、外部記憶装置107に記憶されるようにする。【0038】  ある処理を実行するモジュールが他の処理を実行するモジュールへ処理結果を入力する場合には、あるモジュールが外部記憶装置107を介して処理結果を介して他のモジュールへ入力するようにしてもよい。具体的には、処理部1が処理結果を処理部2に出力し、処理部2に処理部1の処理結果が入力される場合、処理部1が処理結果を外部記憶装置107に出力し、外部記憶装置107が処理結果を記憶し、処理部2は外部記憶装置107に記憶された処理部1の処理結果を入力として取得する。【0039】  また、処理を実行するモジュールは、入力装置102を介してユーザによって適宜制御される。【0040】  図2は、本発明の第1の実施形態の帳票認識装置101による帳票認識処理を実行する各モジュールを説明するための図である。【0041】  帳票認識処理は、帳票に押印された押印領域の文字を認識する処理である。【0042】  帳票認識装置は、例えば、図3に示す帳票に押印の有無を検知し、押印が存在する場合には、押印中に書かれた文字(銀行名、日付等)を認識し、文字の認識結果によって帳票を分類したり、後に参照するために、認識結果とともに帳票イメージを記憶装置に保存しておくことである。例えば、領収印の日付を認識し、認識した日付と納付期限とを照合することで、延滞の有無を判断し、帳票を分類する目的に用いられる。【0043】  帳票認識装置101は、帳票認識処理を実行するためのモジュールとして、イメージ入力部211、押印検出部212、背景色分離部213、傾き補正部214、文字列探索部216、文字切出部217、文字認識部218、知識処理部219、棄却判定部220、リトライ判定部221、認識結果記録部222、及び帳票分類部223を備え、知識処理部219が参照するデータベースとして知識処理用辞書202、及び認識結果記録部222が認識結果を記録するための認識結果DB203を備える。【0044】  各モジュール及びデータベースについて説明する。【0045】  イメージ入力部211は、イメージ取得装置104によって帳票を光学的に走査することによって、帳票画像データを取得し、取得した帳票画像データを押印検出部212に出力する。ここでは、イメージ入力部211は図3に示す帳票画像データを取得したものとする。【0046】  図3は、本発明の第1の実施形態の帳票画像データの説明図である。【0047】  図3に示すように、本実施形態の帳票認識装置101に取り込まれる帳票は税金の領収書であり、右下部に押印がなされている。【0048】  図2に戻り、押印検出部212の説明をする。【0049】  押印検出部212は、イメージ入力部211から入力された帳票画像データ内に押印が存在するか否かを判定し、押印が存在する場合には、帳票画像データから押印領域を検出する。【0050】  具体的には、押印検出部212は、押印が存在する場合には、画像二値化処理、輪郭抽出処理、輪郭追跡処理、及び中心座標・半径推定処理を実行して、押印の形状、及び押印のサイズ(押印が丸印である場合は、押印領域の中心座標及び半径、押印が四角印である場合は、押印領域の縦横の長さ等)等を推定し、押印の外輪郭部分を検出して、背景色分離部213に処理を移す。【0051】  一方、押印検出部212は、押印が存在しない場合には、帳票の認識結果を認識結果DB203に記録し、帳票を分類し、次に読み取るべき帳票がある場合には、イメージ入力部211に処理を移す。【0052】  次に、押印が存在すると判定された場合の押印検出部212の処理について説明する。【0053】  まず、画像二値化処理について説明する。【0054】  押印検出部212は、画像二値化処理では、イメージ入力部211から入力された帳票画像データを構成する画素のうち、所定の輝度値以上の画素を黒画素に変換し、所定の輝度値よりも小さい画素を白画素に変換することによって、帳票画像データを白画素と黒画素とから構成される二値画像データに変換する。【0055】  図3に示す帳票画像データに対して画像二値化処理が実行されることによって、図3に示す帳票画像データは、図4に示す二値画像データに変換される。【0056】  図4は、本発明の第1の実施形態の二値画像データの説明図である。【0057】  図4では、図3に示す帳票画像データを構成する画素のうち、所定の輝度値以上の画素が黒画素に変換され、所定の輝度値よりも小さい画素が白画素に変換されている。【0058】  図2に戻り、押印検出部212の輪郭抽出処理について説明する。【0059】  押印検出部212は、輪郭抽出処理では、画像二値化処理によって変換された二値画像データの黒画素から構成される黒領域の輪郭を抽出して、輪郭画像データを生成する。押印検出部212は、例えば、白画素から構成される白領域と黒画素から構成される黒領域との境界部分の画素を黒画素に変換し、その他の画素を白画素に変換することによって、黒画素から構成される輪郭画像データを生成する。換言すると、押印検出部212は、二値画像データの黒画素のうち、白画素に隣接する黒画素を黒画素のままとし、白画素に隣接しない黒画素を白画素に変換することによって、輪郭画像データを生成する。【0060】  図4に示す二値画像データに対して輪郭抽出処理が実行されることによって、図4に示す二値画像データから図5に示す輪郭画像データが生成される。【0061】  図5は、本発明の第1の実施形態の輪郭画像データの説明図である。【0062】  図5では、図4に示す二値画像データのうち、白領域と黒領域との境界部分の画素が黒画素に変換され、その他の画素が白の画素に変換されている。【0063】  なお、輪郭抽出処理では、輪郭の滑らかさに基づいて、直線及び円周以外を形成する輪郭以外を除去してもよい。【0064】  図2に戻り、押印検出部212の輪郭追跡処理について説明する。【0065】  押印検出部212は、輪郭追跡処理では、輪郭を追跡して、輪郭が円周である場合には当該円の中心座標を推定する処理である。【0066】  輪郭追跡処理の詳細について図6を用いて説明する。【0067】  図6は、本発明の第1の実施形態の輪郭追跡処理の説明図である。【0068】  まず、押印検出部212は、輪郭抽出処理で変換された輪郭画像データの黒画素点から一つの黒画素点X1を選択し、選択された黒画素点X1に他の黒画素点によって接続されているもう一つの黒画素点X3を選択する。そして、押印検出部212は、黒画素点X1及びX3を接続する黒画素点から一つの黒画素点X2を選択する。【0069】  次に、押印検出部212は、黒画素点X1と黒画素点X2とを接続する直線の垂直二等分線と、黒画素点X2と黒画素点X3とを接続する直線の垂直二等分線との交点Cを算出する。【0070】  ここで、交点Cが帳票内に存在しない場合には、黒画素点X1と黒画素点X3とを接続する線は直線であると判定する。一方、交点Cが帳票内に存在する場合、算出された交点Cの座標は、丸印の中心点の推定座標となる。【0071】  このようにして、輪郭追跡処理では、黒画素点X1、X2、及びX3からなるグループが輪郭画像データを構成する黒画素点からN(Nは自然数)個選択され、選択されたN個のグループのN個の交点C1、C2、…、CNが算出される。これらの交点C1、C2、…、CNの座標は、円の中心の推定座標となる。【0072】  図5に示す輪郭画像データに対して輪郭追跡処理が実行され、輪郭画像データからN個のグループを構成する黒画素点が選択された状態を図7に示す。【0073】  図7は、本発明の第1の実施形態の輪郭追跡処理で交点を算出するために選択された黒画素点の説明図である。【0074】  図7では、輪郭追跡処理で選択された黒画素点は、十字によって示される。【0075】  図2に戻り、押印検出部212の中心座標・半径推定処理について説明する。【0076】  押印検出部212は、中心座標・半径推定処理では、輪郭追跡処理で算出された交点C1、C2、…、CNを用いて、丸印の中心座標と丸印の半径を推定する。【0077】  具体的には、押印検出部212は、輪郭追跡処理で算出された交点C1、C2、…、CNのうち、互いに近接する位置に存在する交点の集合を選択し、選択された交点の集合の平均座標を円の中心座標とする。【0078】  また、押印検出部212は、算出された中心座標から、選択された交点の集合を構成する交点の算出に用いた黒画素点の座標までの距離の平均値を円の半径とする。【0079】  そして、押印検出部212は、中心座標・半径推定処理で算出された半径が所定の値よりも大きければ、当該半径から丸印を押印として検出する。【0080】  図8を用いて丸印の半径の算出方法について説明する。【0081】  図8は、本発明の第1の実施形態の丸印の輪郭の中心と半径とを算出する説明図である。【0082】  中心座標・半径処理で算出された中心座標を点Cとして示す。この点Cを算出するために用いた交点を算出に用いた黒画素点の座標をX1〜X25として示す。【0083】  押印検出部212は、点CからX1〜X25までの各距離を算出し、算出された距離の平均を丸印の半径として算出する。【0084】  以上によって、押印検出部212は、押印を検出することでき、押印の中心座標、及び押印のサイズ(半径)を算出できる。なお、押印の中心座標及び押印のサイズから、押印の輪郭及び帳票内での押印の位置を特定できる。【0085】  図2に戻り、背景色分離部213について説明する。【0086】  背景色分離部213は、押印色とその他の色(背景色)を分離することによって、押印領域を抽出する。【0087】  具体的には、背景色分離部213は、押印検出部212によって算出された押印の中心座標及び押印の半径に基づいて、イメージ入力部211から入力された帳票画像データ内での押印の輪郭位置を特定する。そして、背景色分離部213は、特定された押印の輪郭位置付近の色のうち、ピーク色から色空間において所定範囲内に存在する色を押印色として選択する。ピーク色は、押印画像に対して、色空間(例えば、RGB、HCL等)のヒストグラムを算出し、当該ヒストグラムのピークを示す色をピーク色とする。【0088】  押印の輪郭位置付近は、押印の輪郭位置から所定の距離以内に存在する画素を示す。当該所定の距離をr1とし、押印の外接矩形の縦の長さをL1とし、横の長さをL2とし、押印の外接矩形の縦の長さ及び横の長さのうち長い方の長さをL(L=max｛L1、L2｝)とし、kを予め定められた1より小さい正の実数とすると、当該所定の距離はr1=kLとして表現される。【0089】  例えば、押印が円である場合には、押印の輪郭位置から所定の距離以内に存在する画素の座標は、丸印の中心位置をcとし、丸印の半径をrとすると、r−r1<｜｜z−c｜｜<r+r1をとなる点zを座標に位置する画素となる。これによって、押印のサイズ(スケール)が違っていても、押印の輪郭位置から所定の距離以内に存在する画素を抽出できる。【0090】  次に、押印色について説明する。【0091】  押印の輪郭位置から所定の距離以内に存在する画素が有する色情報のピーク色をpとして、ピーク色pに対する色空間における距離が予め設定された所定範囲内になるような色xを押印色として抽出する。ここで、押印色xとピーク色pとの色空間における距離D(x、p)とし、予め設定された所定範囲を示す値をr2とすると、D(x、p)≦r2を満たすようなすべての色xが押印色として抽出される。色aと色bとの色空間における距離D(a、b)としては、例えば、RGB色空間上のユークリッド距離、及びHCL空間上のHCL色距離等を用いてもよい。【0092】  押印色xとして抽出されていない画素の色を背景色とすることによって、押印色の画素を押印部とし、背景色の画素を背景部とし、押印色と背景色とが分離される。これによって、帳票に存在する押印が帳票のプレ印刷と重複していても、押印部を正確に検出できるようになる。【0093】  次に、傾き補正部214について説明する。【0094】  傾き補正部214は、背景色分離部213によって押印色が背景色と分離された押印画像の押印の傾きを補正する。【0095】  以下に、傾き補正部214による押印の傾き補正処理について説明する。【0096】  傾き補正部214は、押印中に存在する線分(図9に示す日付区切り線)を利用して押印の傾きを検出する。具体的には、傾き補正部214は、押印検出部212によって検出された押印の輪郭よりも内側(例えば、中心がc、半径がrの円の場合には、｜｜z−c｜｜<rとなるすべての画素z)に存在する線分を検出し、傾き補正部214に設定されたx軸を基準として検出した線分の傾きを算出する。そして、傾き補正部214は算出された線分がx軸に一致するように、押印部全体を回転させることによって、押印の傾きを補正する。また、帳票内に存在する線分からx軸に対する傾き最も小さい線分を検出して、検出した線分を押印の傾き基準となる線分として利用してもよい。【0097】  また、押印中に複数の線分(日付区切り線)が存在する場合には、傾き補正部214は、まず、任意の一つの線分を選択し、選択された線分に基づいて押印部の傾きを補正する。そして、後述する棄却判定部220によって文字認識が棄却された場合には、リトライ判定部221が、傾き補正部214が未だ選択されていない他の線分を選択し、選択された線分に基づいて押印の傾きを補正するようにしてもよい。【0098】  なお、傾き補正部214は、押印検出部212の輪郭追跡処理で用いた輪郭追跡方法を用いてもよい。【0099】  図9は、本発明の第1の実施形態の押印の日付区切り線の説明図である。【0100】  図9に示すように、日付を示す文字列「20.5.31」の上側には第1日付区切り線901が存在し、下側には第2日付区切り線902が存在している。【0101】  以上のように、押印中に存在する線分から押印の傾きを検出して、当該傾きをある基準線に一致させるように補正するので、帳票に傾いた押印がされていても、当該傾きを補正して押印部を抽出することができる。このため、押印中の文字認識を正確に行うことができる。さらに、押印中の線分を用いて傾きを検出するため、罫線をある方向に射影したヒストグラムを用いて傾き補正する特許文献2及び3に記載された発明よりも、処理時間を短縮できる。【0102】  図2に戻り、文字列探索部216について説明する。【0103】  文字列探索部216は、傾き補正部214によって傾きが補正された押印から、第1日付区切り線901、第2日付区切り線902、及び押印の輪郭に基づいて、文字が存在する領域である文字領域を特定し、特定された文字領域から文字列を探索し、探索された文字列を抽出する。ここでは、図10に示す文字列が抽出されたものとする。【0104】  図10は、本発明の第1の実施形態の文字列探索部216によって抽出された文字列の説明図である。【0105】  文字列探索部216によって、「20.5.31」からなる文字列が抽出される。ここで、「2」の文字は斜線とともに抽出されている。これは、図3に示す帳票画像データで押印とプレ印刷とが重なっていることに起因している。【0106】  図2に戻り、文字切出部217について説明する。文字列探索部216によって抽出された文字列から各文字を切り出す。【0107】  具体的には、文字切出部217は、例えば、黒画素と黒画素とを連結する成分を算出し、算出された成分を文字として切り出す。【0108】  なお、押印に存在する文字は、押印時のインクの滲みが原因で、別々の文字が連結してしまう場合もある。このため、文字切出部217は、黒画素と黒画素とを連結する成分の輪郭の滑らかさを用いて連結成分を分離することによって、インクの滲み等が原因で連結してしまった複数の文字を異なる文字として切り出してもよい。【0109】  文字認識部218は、文字切出部217によって切り出された個々の文字を認識し、文字列探索部216によって抽出された文字列を構成するすべての文字を認識した結果である複数の文字認識結果を算出する。【0110】  なお、単一文字の認識方法には様々な公知の方法が存在し、これらの認識方法から文字認識部218で用いる認識方法を選択して、選択した認識方法を用いることができる。【0111】  さらに、文字認識部218は、認識した個々の文字に対する信頼度を算出する。【0112】  知識処理部219は、文字認識部218によって算出された複数の文字認識結果のうち、帳票認識装置101に予め設定された辞書に登録された形式に合致する文字認識結果を選択する。なお、帳票認識装置101に予め設定された辞書とは、図2に示す知識処理用辞書202に記録されている辞書である。【0113】  棄却判定部220は、知識処理部219によって選択された各文字認識結果に対して信頼度を算出し、算出された信頼度に基づいて知識処理部219によって選択された文字認識結果を棄却するか否かを判定する。【0114】  各文字認識結果に対して信頼度を算出する処理について説明する。【0115】  例えば、知識処理部219によって選択された文字認識結果のL個の文字を含む文字列を構成する個々の文字の認識結果の信頼度がX1、X2、…、XLである場合に、棄却判定部220は、当該文字認識結果の信頼度(X)をX=(X1+…+XL)/Lによって算出する。【0116】  そして、棄却判定部220は、当該文字認識結果の信頼度が予め設定された閾値よりも小さい場合には、当該文字認識結果の信頼度が低いと判断し、当該一の文字認識結果を棄却する。【0117】  また、棄却判定部220は、各文字の認識結果の信頼度に対して重み付けをして、文字認識結果の信頼度を算出してもよい。【0118】  具体的には、棄却判定部220は、L個の個々の文字の認識結果の重みをa1、a2、…、aL(a1+…+aL=1)とし、一の文字認識結果の信頼度(X)をX=(a1・X1+…+aL・XL)/Lとしてもよい。【0119】  例えば、棄却判定部220は、知識処理部219によって選択された文字認識結果が年月日を示す文字列を示す場合には、「日」に対応する文字、「月」に対応する文字、及び「年」に対応する文字の順に重みが小さくなるようにしてもよい。つまり、「年」に対応する文字の信頼度の重み付けを最も低くし、次いで「月」に対応する文字の信頼度の重み付けを低くし、「日」に対応する文字の信頼度の重み付けを最も高くする。これによって、ユーザにとって重要となる文字の認識に高い信頼度を要求するように設計できる。【0120】  以上によって、棄却判定部220は、信頼度が閾値よりも小さい文字認識結果を棄却するため、例えば、かすれによって押印中の日付欄のピリオドが消失した場合、及び、かすれにより数字の一部が欠けた場合の文字認識結果の信頼度は通常の文字認識結果よりも低くなるため、このような場合の文字認識結果を棄却することができる。これによって、帳票認識装置101の文字の誤認識を防止することができる。【0121】  リトライ判定部221は、再度文字列探索部216まで処理を移行させ、文字認識を再度実行(リトライ)するか、処理を終了するかを判定する。リトライ判定部221は、例えば、知識処理部219によって選択されたすべての文字認識結果が棄却判定部220によって棄却された場合に、リトライすると判定する。【0122】  リトライ判定部221によってリトライすると判定された場合には、リトライ判定部221が、押印の傾きを再度補正する場合がある。【0123】  具体的には、押印に複数の線分(日付区切り線)が存在する場合、及び押印が反転している場合等である。押印に複数の線分が存在する場合のリトライ判定部221の処理については、傾き補正部214で説明したので、説明を省略する。【0124】  押印が反転している場合のリトライ判定部221の処理について説明する。【0125】  傾き補正部214によって押印の傾きが補正されても、補正後の押印が図11に示すように傾き補正後の押印が反転している場合がある。図11は、本発明の第1の実施形態の押印が傾き補正された状態の説明図である。リトライ判定部221は、当該傾き補正後の押印を180度回転させてから、文字列探索部216へ処理を移行する。【0126】  押印が反転しているか否かの判定については、リトライ判定部221は、例えば、知識処理部219によって選択された文字認識結果の信頼度の平均値が予め設定された閾値よりも小さい場合に、押印が反転していると判定する。【0127】  認識結果記録部222は、知識処理部219によって選択された文字認識結果が棄却された場合であっても、棄却されなかった場合であっても、当該文字認識結果を含む帳票の認識結果を認識結果データベース(DB)203へ記録する。【0128】  認識結果DB203に記録される帳票の認識結果には、帳票画像データ、押印画像データ、傾き補正後の押印画像データ、及び押印情報等を含む情報が含まれてもよい。押印情報は、押印形状(押印輪郭)、押印サイズ、押印中の文字列位置及び文字列情報、文字列中の文字位置、文字の大きさ、並びに押印色等を含む。【0129】  なお、認識結果DB203に登録された情報は、押印中の文字列情報(銀行名、及び日付等)をキーにした検索に用いられてもよい。【0130】  帳票分類部223は、押印中の文字認識の結果に基づいて、帳票を分類する。例えば、帳票分類部223は、銀行名ごとに分類してもよいし、また、押印が領収印である場合には、支払い期限当日以前に押印された帳票と支払い期限翌日以降に押印された帳票とで分類してもよい。【0131】  以上のように、本実施形態の帳票認識装置101は、背景色分離部213を備えるので、押印色と背景色とを分離し、押印色近傍の色を有する画素を押印部の輪郭として抽出するため、押印がプレ印刷等と重なっていても、押印部の輪郭を正確に抽出できる。【0132】  また、本実施形態の帳票認識装置101は、傾き補正部214を備えるので、押印が傾いている場合には、当該押印の傾き補正してから押印中の文字を認識するため、押印が傾いている場合であっても、押印中の文字を正確に認識できる。【0133】  また、本実施形態の傾き補正部214は、押印の傾き補正に押印中の線分(日付区切り線)を用いるため、罫線をある方向に射影したヒストグラムを用いて傾き補正する特許文献2及び3に記載された発明よりも、処理時間を短縮できる。さらに、本実施形態は、日付区切り線は輪郭追跡処理によって抽出されるので、日付区切り線がプレ印刷と重なっている場合であっても、日付区切り線がかすれている場合であっても、日付区切り線を正確に抽出できる。【0134】  また、本実施形態の帳票認識装置101は、棄却判定部220を備えるので、文字認識がなされた文字列の信頼度が所定の閾値よりも小さい場合には、当該文字列を棄却するので、帳票認識装置101の文字の誤認識を防止できる。【0135】  さらに、棄却判定部220は、文字認識がなされた文字列の信頼度を各文字に重み付けをして算出する場合に、「年」に対応する文字の信頼度の重み付けを最も低くし、次いで「月」に対応する文字の信頼度の重み付けを低くし、「日」に対応する文字の信頼度の重み付けを最も高くする。これによって、帳票認識装置101の認識対象となる帳票に、押印の年が異なる帳票が混在するケースはまれであるため、「月」及び「日」の文字認識の信頼度を、「年」の文字認識の信頼度よりも高くすることによって、帳票認識装置101が「月」及び「日」の文字を誤って認識してしまうことを防止できる。【0136】  (第2の実施形態)  次に、本発明の第2の実施形態を図12〜図14を用いて説明する。【0137】  本発明の第2の実施形態の帳票認識装置101は、図13に示す押印認識用辞書301を参照して帳票に存在する押印の種別を特定し、押印認識用辞書301に登録された押印の種別に対応する情報を参照して、帳票に存在する押印の文字を認識する。【0138】  これによって、押印中の文字列、文字列の意味(日付、及び銀行名等)、文字列の位置、文字の位置、及び文字大きさは、押印種ごとに決まっているため、押印の種別を特定することによって、文字の位置が決まり、文字列探索部316及び文字切出部317がこれらの情報を用いることによって、文字を誤って切り出すること、及び文字を誤って認識することを低減できる。【0139】  本発明の第2実施形態の帳票認識装置101によって実行される処理は、帳票に存在する押印を認識する認識フェーズ(帳票認識処理)と、押印を認識するために参照する押印認識用辞書301を生成する学習フェーズ(押印認識用辞書生成処理)とによって構成される。【0140】  認識フェーズでは、帳票認識装置101は、帳票に存在する押印を次々と認識し、押印に基づいて帳票を分類する。帳票認識装置101は、認識フェーズで、押印認識用辞書301を参照する場合もある。学習フェーズでは、帳票認識装置101は、認識結果DB203に記録された認識結果、又はユーザによって入力された定義に基づいて、押印認識用辞書301を生成する。【0141】  認識フェーズを実行するためのモジュール及びデータベースを図12に示し、学習フェーズを実行するためのモジュール及びデータベースを図14に示す。【0142】  本実施形態では、認識フェーズの処理を実行する装置(認識装置)と学習フェーズの処理を実行する装置(押印認識用辞書生成装置)とは帳票認識装置101によって実行されるものとするが、別々の装置によって実行されてもよい。認識フェーズの処理と学習フェーズの処理とが別々の装置によって実行される場合、認識フェーズの処理を実行する認識装置は図12に示すモジュールを備え、押印認識用辞書生成装置によって生成された押印認識用辞書を用いて、入力帳票に存在する押印を認識する。学習フェーズの処理を実行する押印認識用辞書生成装置は図14に示すモジュールを備え、認識結果DB203に記録されている認識結果、及びユーザによって入力された定義に基づいて、押印認識用辞書301を生成する。各モジュールの処理は、演算装置106によって実行される。【0143】  図12は、本発明の第2の実施形態の帳票認識装置101による帳票認識処理を実行する各モジュールを説明するための図である。図12に示すモジュールのうち本発明の第1の実施形態と同じモジュールは同じ番号を付与し、説明を省略する。【0144】  本実施形態の帳票認識装置101は、イメージ入力部211、押印検出部212、背景色分離部213、傾き補正部214、辞書利用判定部315、文字列探索部316、文字切出部317、文字認識部318、知識処理部319、棄却判定部320、リトライ判定部321、認識結果記録部222、帳票分類部223、押印種特定部331、及び押印劣化判定部332を備え、知識処理部219が参照するデータベースとして知識処理用辞書202、認識結果記録部222が認識結果を記録するための認識結果DB203、及び押印種特定部331が参照するデータベースとして押印認識用辞書301を備える。【0145】  各モジュール及び各データベースについて説明する。なお、図12に示すモジュール及びデータベースのうち本発明の第1の実施形態と同じモジュール及びデータベースは同じ番号を付与し、説明を省略する。【0146】  辞書利用判定部315は、押印認識用辞書301を用いて文字を認識するか否かを判定する。辞書利用判定部315によって押印認識用辞書301を用いて文字を認識すると判定された場合には、押印種特定部331に処理を移行する。辞書利用判定部315によって押印認識用辞書301を用いて文字を認識すると判定された場合には、文字列探索部316に処理を移行する。なお、押印認識用辞書301は、図13で詳細を説明する。【0147】  辞書利用判定部315の判定処理は、例えば、帳票認識装置101が導入されてから帳票認識処理が所定回数実行されるまで、押印認識用辞書を用いないで文字を認識すると判定し、帳票認識処理が所定回数実行されると押印認識用辞書を用いて文字を認識すると判定してもよい。これによって、押印認識用辞書301に登録された押印情報が所定数になると、押印認識用辞書301を用いて文字を認識するので、押印に存在する文字列の文字を正確に認識できる。【0148】  また、辞書利用判定部315の判定処理は、一回目の文字認識は押印認識用辞書301を用いないで文字を認識すると判定し、文字認識が二回目以降となった場合、つまりリトライ判定部321によって再度文字を認識すると判定された場合には、押印認識用辞書301を用いて文字を認識すると判定するようにしてもよい。【0149】  辞書利用判定部315によって押印認識用辞書301を用いないで文字を認識すると判定された場合の文字列探索部316の処理は、第1の実施形態の文字列探索部216の処理と同じであるので、説明を省略する。【0150】  辞書利用判定部315によって押印認識用辞書301を用いて文字を認識すると判定された場合には、文字列探索部316は、押印認識用辞書301に登録された押印情報のうち押印種特定部331によって特定された押印種別の押印文字列位置1305(図13参照)に登録された座標を参照して、帳票に存在する文字列を抽出する。【0151】  辞書利用判定部315によって押印認識用辞書301を用いないで文字を認識すると判定された場合の文字切出部317の処理は、第1の実施形態の文字切出部217の処理と同じであるので、説明を省略する。【0152】  辞書利用判定部315によって押印認識用辞書301を用いて文字を認識すると判定された場合には、文字切出部317は、押印認識用辞書301に登録された押印情報のうち押印種特定部331によって特定された押印種別の個々の文字位置1307(図13参照)に登録された座標を参照して、文字を切り出す。【0153】  辞書利用判定部315によって押印認識用辞書301を用いないで文字を認識すると判定された場合の文字認識部318の処理は、第1の実施形態の文字認識部218の処理と同じであるので、説明を省略する。【0154】  辞書利用判定部315によって押印認識用辞書301を用いて文字を認識すると判定された場合には、文字認識部318は、押印劣化判定部332によって算出された押印の劣化度(かすれ度及びつぶれ度)に応じて、文字認識処理方法を切り替える。【0155】  文字認識部318は、例えば、押印のかすれ度が大きい場合には、かすれ文字を学習した文字認識方法を用いて文字を認識し、押印のつぶれ度が大きい場合には、つぶれ文字を学習した文字認識方法を用いて文字を認識することによって、押印による文字の劣化に適した文字認識方法を用いることができ、文字認識の精度を向上できる。【0156】  辞書利用判定部315によって押印認識用辞書301を用いないで文字を認識すると判定された場合の知識処理部319の処理は、第1の実施形態の知識処理部219の処理と同じであるので、説明を省略する。【0157】  辞書利用判定部315によって押印認識用辞書301を用いて文字を認識すると判定された場合には、知識処理部319は、文字認識結果の形式と、押印認識用辞書301に登録された押印情報のうち押印種特定部331によって特定された押印種別の押印文字列形式1306に登録されている形式とが一致する文字認識結果を選択する。【0158】  リトライ判定部321は、本発明の第1の実施形態のリトライ判定部221によって実行される処理の他に、辞書利用判定部315によって押印認識用辞書301を用いないで文字を認識すると判定された場合の文字認識がリトライと判定されると、押印認識用辞書301を用いて再度文字を認識するようにしてもよい。【0159】  押印種特定部331は、押印認識用辞書301に登録された押印情報を用いて、押印の種類を特定する。【0160】  まず、押印認識用辞書301を図13を用いて説明する。【0161】  図13は、本発明の第2の実施形態の押印認識用辞書301の説明図である。【0162】  押印認識用辞書301は、押印ID1301、押印テンプレート画像1302、押印形状1303、押印サイズ1304、押印文字列位置1305、押印文字列形式1306、個々の文字位置1307、及び押印色1308を含む。【0163】  押印ID1301には、押印の種別の一意な識別子が登録される。押印テンプレート画像1302には、押印の種別ごとのテンプレート画像が登録される。押印テンプレート画像1302に登録されるテンプレート画像は、二値画像又は多値画像(グレー画像)である。【0164】  押印形状1303には、押印の種別ごとに押印の形状が円であるか、長方形であるか、楕円であるか等が登録される。押印サイズ1304には、押印の形状が円である場合には半径が登録され、押印の形状が長方形である場合には縦の長さ及び横の長さが登録され、押印が楕円である場合には短径及び長径が登録される。【0165】  押印文字列位置1305には、押印に存在する文字列の種類ごとに文字列が押印中に存在する座標が登録される。文字列の種類には、例えば、年月日を示す文字列の種類と銀行の支店名を示す文字列の種類とがある。押印文字列位置1305には、例えば、押印の外接矩形の左下の角の座標を基準にした文字列が存在する座標が登録される。【0166】  押印文字列形式1306には、同じ種類の押印に存在する文字列の種類ごとの文字列の形式が登録される。例えば、年月日を示す文字列の種類の押印文字列形式1306には、YYMMDDが登録される。YYMMDDは、6桁の数字から構成される文字列であることを示し、YYは年を表し00〜99の数字からなり、MMは月を表し01〜12の数字からなり、DDは日を表し01〜31の数字からなる。また、支店名を示す文字列の種類の押印文字列形式1306には、XX支店が登録される。【0167】  個々の文字位置1307には、同じ種類の押印に存在する文字列を構成する各文字の位置を示す座標が登録される。年月日を示す文字列の種類の個々の文字位置1307には、年を示す個々の文字の位置の座標、月を示す個々の文字の位置の座標、及び日を示す個々の文字の位置の座標が登録される。なお、個々の文字位置1307には、押印文字列位置1305と同じく、例えば、押印の外接矩形の左下の角の座標を基準にした文字列が存在する座標が登録される。【0168】  押印色1308には、同じ種類の押印の押印色が登録される。押印色は背景色分離部213によって抽出される。【0169】  図12に戻り、押印種特定部331を説明する。【0170】  押印種特定部331は、傾き補正部214によって生成された傾き補正後の押印画像と押印認識用辞書301の押印テンプレート画像1302とを比較することによって、押印画像の種別を特定する。【0171】  押印画像の種別特定処理について説明する。【0172】  まず、押印種特定部331は、押印認識用辞書301に登録された押印種別のうち、押印形状1303に登録された形状と押印検出部212によって検出された押印画像の形状と一致するエントリを選択する。そして、押印種特定部313は、選択されたエントリの押印サイズ1304に登録されたサイズと押印検出部212によって検出された押印画像のサイズとの差が所定の閾値以下であるエントリの押印テンプレート画像1302に登録されたテンプレート画像を選択する。押印種特定部331は、選択されたテンプレート画像と押印画像とを比較する。【0173】  次に、押印種特定部331は、押印画像の中心とテンプレート画像の中心とを合わせてどちらの画像の輪郭が大きいかを判定する。押印種特定部331は、輪郭が大きいと判定された方の画像に余白等を追加し、両方の画像の輪郭が一致するようにする。【0174】  そして、押印種特定部331は、押印画像pとテンプレート画像qとを、関数K(p,q)を用いて比較する。以下、押印画像及びテンプレート画像は、二値画像又はグレー画像であるものとし、黒画素が1、白画素が0となるように正規化されているものとする。また、画像位置xに位置する押印画像pの画素値をp(x)とし、テンプレート画像の画素qの画素値をq(x)とする。【0175】  以下に、押印画像pとテンプレート画像qとを比較するために用いられる関数の例を説明する。【0176】  押印画像pとテンプレート画像qとの比較に用いられる関数には、f(a、b)を｜a−b｜の値に応じて広義単調増加する関数である数式1に示すK(p,q)がある。数式1では、全画素にわたって和が算出される。【0177】【数1】【0178】  本実施形態の押印種特定部331は、広義単調増加する関数として、例えば、数式2〜数式5に示す関数を用いることができる。【0179】  まず、数式2及び数式3について説明する。【0180】  数式1に示す関数では、押印画像pの画素値p(x)とテンプレート画像qとの画素値q(x)との差の絶対値の和がすべての画素位置に対して算出される。【0181】【数2】【0182】  数式3に示す関数では、押印画像pの画素値p(x)とテンプレート画像qとの画素値q(x)との差の絶対値を二乗した値の和がすべての画素位置に対して算出される。【0183】【数3】【0184】  数式2及び数式3に示す関数では、押印画像pの画素値p(x)とテンプレート画像qの画素値q(x)との違いが大きいほど、K(p,q)の値が大きくなる。このため、押印種特定部331は、押印画像pとテンプレート画像qとの比較に数式2又は数式3に示す関数を用いた場合には、K(p,q)の値が最小となるテンプレート画像qを押印種別を示す画像として特定する。【0185】  次に、数式4及び数式5について説明する。【0186】【数4】【0187】【数5】【0188】  数式4に示す関数では、押印画像pの画素値p(x)がテンプレート画像qの画素値q(x)よりも大きくなる画素に対してのみ演算する。また、数式5に示す関数では、テンプレート画像qの画素値q(x)が0よりも大きく、かつ押印画像pの画素値p(x)が0よりも大きい画素に対してのみ演算する。【0189】  数式4及び数式5に示す関数は、K(p,q)とK(q,p)とが異なる非対称関数である。なお、数式2及び数式3に示す関数は、K(p,q)とK(q,p)とが同じになる対称関数である。【0190】  数式4及び数式5に示す関数では、テンプレート画像qと比較して押印画像pがつぶれているほど、換言すると、押印画像pと比較してテンプレート画像qがかすれているほど、K(p,q)の値が大きくなる。つまり、押印画像pで黒に近い画素がテンプレート画像qよりも多いほど、K(p,q)の値が大きくなる。数式4において、押印画像pと比較してテンプレート画像qがかすれているほどK(p,q)の値が大きくなるのは、p>qとなるような画素に対してのみ演算しているからである。【0191】  また、数式5において、押印画像pと比較してテンプレート画像qがかすれているほどK(p,q)の値が大きくなるのは、log(q(x)/p(x))が、p(x)>q(x)のときに値が正となり、数式5の和の中のlog((q(x)+ε)/p(x))は、q(x)=0となるときにも演算できるように、正の実数ε>0でlog(q(x)/p(x))を、補正したものだからである。【0192】  テンプレート画像qが示す押印の種別が押印画像pの押印の種別と同じである場合には、テンプレート画像qを基準とした押印画像pのつぶれ度がK(p,q)によって算出でき、テンプレート画像qを基準とした押印画像pのかすれ度がK(q,p)によって算出できる。【0193】  なお、K(p,q)がテンプレート画像qを基準とした押印画像pのかすれ度を示し、K(q,p)がテンプレート画像qを基準とした押印画像pのつぶれ度を示すようにすることもできる。具体的には、数式4では、押印画像pの画素値p(x)がテンプレート画像qの画素値q(x)よりも大きくなる画素に対してのみ演算しているが、テンプレート画像qの画素値q(x)が押印画像pの画素値p(x)よりも大きくなる画素に対してのみ演算するようにすればよい。また、数式5では、押印画像pの画素値p(x)がp(x)>0となる画素に対してのみ演算しているが、数式5において、pとqを入れ替え、q(x)>0となるような画素に対してのみ、演算するようにすればよい。【0194】  ここで、押印種特定部331は、数式4又は数式5に示す関数を用いて押印画像pの押印種別を特定する場合には、α及びβを定数として、αK(p,q)+βK(q,p)の値が最小となるテンプレート画像qを押印種別を示す画像として特定する。【0195】  次に、押印劣化判定部332について説明する。【0196】  押印劣化判定部332は、押印画像pと、当該押印画像pに対応する押印種別のテンプレート画像qとを比較することによって、押印画像pの劣化度を判定し、押印画像pの劣化度に対応する文字認識方法を選択して、文字列探索部316へ処理を移行する。なお、押印劣化判定部332は、押印画像pの劣化度が所定値以上である場合には、当該押印画像の文字を認識しないように、文字列探索部316へ処理を移行させないようにしてもよい。【0197】  押印劣化判定部332は、押印画像pの劣化度の判定には、数式1〜5を用いてもよい。例えば、数式2及び数式3に示す関数を用いてもよい。この場合、押印劣化判定部332は、数式2及び数式3に示す関数のK(p,q)の値が大きいほど、押印画像pの劣化が大きいものと判定する。【0198】  また、押印劣化判定部332は、数式4及び数式5に示す関数(K(p,q)及びK(q,p))を用いて、押印画像pのつぶれ度及びかすれ度を劣化度として判定してもよい。数式4及び数式5に示す関数を用いた場合には、押印劣化判定部332は、K(p,q)の値が大きければ押印画像pのつぶれによる劣化度が大きいと判定し、つぶれが大きい場合の文字認識方法を選択する。一方、K(q,p)の値が大きければ押印画像pのかすれによる劣化度が大きいと判定し、かすれが大きい場合の文字認識方法を選択する。【0199】  以上によって、本実施形態では、押印認識用辞書301に登録された文字の位置情報のうち、認識する押印と同じ種類の文字の位置情報を用いて、認識する押印に存在する文字を認識する。押印の種類ごとに、当該押印に存在する文字の位置等は決まっているので、帳票認識装置101は正確に文字認識を行うことができる。例えば、日付の年、月、日の位置は印鑑のベルト位置によって決まっているため、日付区切り点であるピリオドが消失している場合であっても、帳票認識装置101は正確に年月日を認識できる。【0200】  また、本実施形態では、押印画像と当該押印画像と同じ種類の押印テンプレート画像とを比較することによって、押印画像の劣化度を判定する。このため、押印画像の劣化度が所定値よりも大きい場合には、押印中の文字認識をさせないようにすることによって、押印画像がかすれ又はつぶれによる劣化がひどく、文字の全部又は一部が欠落している場合の誤認識を低減できる。また、本実施形態では、押印画像の劣化度に応じて文字認識の処理方法を変更する。これによって、押印画像の劣化度合に適した文字認識処理を選択することができるため、文字認識の精度を向上させることができる。【0201】  次に、学習フェーズについて説明する。【0202】  図14は、本発明の第2の実施形態の押印テンプレート生成処理を実行する各モジュールを説明するための図である。【0203】  押印テンプレート生成処理は、帳票認識処理を実行する帳票認識装置101と異なる装置によって実行されてもよいが、ここでは帳票認識装置101によって実行されるものとする。【0204】  帳票認識装置101は、押印テンプレート生成処理を実行するためのモジュール及びデータベースとして、押印テンプレート生成部401、ユーザ押印登録部402、押印認識用辞書201、及び認識結果DB203を備える。【0205】  押印テンプレート生成処理では、帳票認識処理における押印種特定部331による押印画像の押印の種別の特定処理、文字列探索部316による押印中の文字列の位置の特定処理、文字切出部317による押印中の文字の各文字の位置の特定処理、及び押印劣化判定部332による劣化度の判定処理等で用いられる押印認識用辞書301が生成される。【0206】  帳票認識装置101は、ユーザによって直接入力された各種情報を押印認識用辞書301に登録するユーザ押印登録部402、及び帳票認識処理で認識結果DB203に記憶された認識結果を押印認識用辞書301に登録する押印テンプレート生成部401を備える。【0207】  押印テンプレート生成部401は、認識結果DB203に記憶された情報等に基づいて帳票を押印の種類ごとに分類する。そして、押印テンプレート生成部401は、分類された押印の種類ごとに押印テンプレート画像を生成し、生成された押印テンプレート画像を押印情報(押印の形状、サイズ、及び押印色等)とともに押印認識用辞書301に登録する。この押印テンプレート生成部401の処理は、押印分類処理、押印テンプレート生成処理、及び押印情報登録処理に分けられる。【0208】  まず、押印テンプレート生成部401の押印分類処理について説明する。【0209】  押印分類処理では、押印テンプレート生成部401は、認識結果DB203に記憶された押印画像を、形状、文字認識結果、文字位置、及びサイズ等に基づいて、一つ又は複数の種類に分類する。なお、押印テンプレート生成部401は、文字の認識に失敗している押印画像は分類の対象としなくてもよい。【0210】  また、押印分類処理では、押印のうち日付等の文字列は、印鑑に備わるベルトを回転させること等によって変更されるため、押印のうち変更されない文字列(「出納済」、及び「領収」等の文字列)を対象として押印画像を分類する。ただし、変更可能な文字列であっても、変更可能な文字列を構成する文字の位置、及び当該文字の大きさについては不変であるので、押印テンプレート生成部401は、文字の位置、及び当該文字の大きさは取得する。【0211】  ここで、押印テンプレート生成部401の押印分類処理を具体的に説明する。【0212】  まず、押印テンプレート生成部401は、認識結果DB203に記憶された押印画像から一つの押印画像を分類対象押印画像として選択し、選択された押印画像と同じ形状の押印画像のうち不変の文字列が選択された押印画像と一致する押印画像を種類押印画像として選択する。【0213】  次に、押印テンプレート生成部401は、種類押印画像のうち、分類対象押印画像のサイズと種類押印画像のサイズとがユーザによって指定された閾値h1よりも小さく、かつ、分類対象押印画像の文字位置と種類押印画像の文字位置とがユーザによって指定された閾値h2よりも小さい押印画像を同一種押印画像として選択する。ただし、両者の文字位置のうち、日付を示す文字列を構成する各文字の文字位置の縦方向のずれは、文字位置の違いとして考慮しない。これは、日付を示す文字列を構成する各文字は、印鑑のベルトの回転によって変更されるものが多く、縦方向のずれは同じ印鑑であっても生じるからである。【0214】  次に、押印テンプレート生成部401の押印テンプレート生成処理について説明する。【0215】  押印テンプレート生成処理では、押印テンプレート生成部401は、押印分類処理で選択された分類対象押印画像と同一種押印画像との間で、中心位置及び輪郭位置のずれがユーザによって指定された閾値h3よりも小さくなるように、両者の画像サイズを適合させる。具体的には、押印テンプレート生成部401は、両者の押印画像の中心位置を合わせて、輪郭が小さい方の押印画像に余白を追加することによって、両者の画像サイズを適合させる。【0216】  さらに、押印テンプレート生成部401は、両者の押印画像から日付などの可変文字列を取り除く。認識結果DB203には両者の押印画像中の文字位置が登録されているので、押印テンプレート生成部401は、認識結果DB203を参照して、両者の押印画像中の可変文字列の文字位置を特定し、特定した文字位置の画素を白画素に変換する。【0217】  次に、押印テンプレート生成部401は、両者の押印画像を二値化画像に変換する。具体的には、押印テンプレート生成部401は、両者の押印画像を構成する画素のうち輝度値がユーザによって指定された閾値h4以上の画素を黒画素に変換し、輝度値がユーザによって指定された閾値h4より小さい画素を白画素に変換する。【0218】  次に、押印テンプレート生成部401は、二値化画像に変換された両者の押印画像から一つの255階調のグレー画像を生成し、生成したグレー画像を押印テンプレート画像とする。【0219】  押印テンプレート生成部401のグレー画像を生成する処理について説明する。【0220】  ここで、同一種押印画像としてN−1個の押印画像が選択されていて、分類対象押印画は1個であるため、両者の押印画像の個数はN個であるものとする。また、二値化画像に変換された両者の押印画像のうち任意の一の押印画像iの画像位置xにおける画素値(黒は1、白は0等とする)をpi(x)とする。【0221】  グレー画像の画像位置xの画素値p(x)は、p(x)=(p1(x)+…+pN(x))/255によって算出される。【0222】  グレー画像の押印テンプレート画像が作成されることによって、押印時のインクの濃さの違いによる押印の輪郭及び文字の太さの違いに対する頑健性を向上させることができる。【0223】  次に、押印テンプレート生成部401の押印情報登録処理について説明する。【0224】  押印情報登録処理では、押印テンプレート生成部401は、押印認識用辞書301に、押印テンプレート生成処理で生成された押印テンプレート画像を登録するためのエントリを新たに生成する。【0225】  そして、押印テンプレート生成部401は、生成されたエントリの押印テンプレート画像1302に、押印テンプレート生成処理で生成された押印テンプレート画像を登録する。【0226】  そして、押印テンプレート生成部401は、当該エントリの押印ID1301に一意な識別子を登録し、押印形状1303に押印テンプレート画像の形状を登録する。また、押印テンプレート生成部401は、当該エントリの押印サイズ1304に、押印テンプレート生成処理で生成された押印画像のサイズが登録される。【0227】  押印テンプレート生成部401は、当該エントリの押印文字列位置1305に、押印テンプレート画像中に存在する文字列の位置を示す座標を登録し、当該エントリの押印文字列形式1306に、押印テンプレート画像中に存在する文字列の形式を登録する。【0228】  また、押印テンプレート生成部401は、当該エントリの個々の文字位置1307に、押印テンプレート画像中に存在する文字列を構成する文字の位置を登録し、当該エントリの押印色1308に、押印色を登録する。【0229】  以上のように、押印テンプレート生成部401は、図13に示す押印認識用辞書301を生成する。【符号の説明】【0230】  101    帳票認識装置  102    入力装置  103    表示装置  104    イメージ取得装置  105    通信装置  106    演算装置  107    外部記憶装置  201    押印認識用辞書  202    知識処理用辞書  203    認識結果DB  211    イメージ入力部  212    押印検出部  213    背景色分離部  214    傾き補正部  216    文字列探索部  217    文字切出部  218    文字認識部  219    知識処理部  220    棄却判定部  221    リトライ判定部  222    認識結果記録部  223    帳票分類部  301    押印認識用辞書
【特許請求の範囲】【請求項1】  帳票を光学的に走査することによって得られた帳票画像を取得するイメージ入力部と、  前記イメージ入力部によって取得された帳票画像から押印画像を検出する押印画像検出部と、  前記押印画像の輪郭の色を示す押印色とその他の色とを分離する背景色分離部と、  前記背景色分離部によって前記押印色が前記その他の色と分離された前記押印画像の傾きを補正する傾き補正部と、  前記傾き補正部によって傾きが補正された前記押印画像から文字列を探索し、前記探索された文字列を切り出す文字列探索部と、  前記文字列探索部によって切り出された文字列から、前記文字列を構成する各文字を切り出す文字切出部と、  前記文字切出部によって切り出された各文字を認識し、前記文字列を構成するすべての文字を認識した結果を示す文字認識結果を算出し、前記認識された各文字の信頼度を算出する文字認識部と、  前記文字認識部によって算出された文字認識結果から、予め指定された文字列形式に適合する文字認識結果を選択し、前記選択された文字認識結果に対する信頼度を前記文字認識部によって算出された各文字の信頼度に基づいて算出する知識処理部と、  前記知識処理部によって選択された文字認識結果と当該文字認識結果の信頼度とに基づいて、前記知識処理部によって選択された文字認識結果を棄却するか否かを判定する棄却判定部と、  前記棄却判定部によって前記文字認識部による文字認識結果が棄却された場合に、押印画像の文字を再度認識させるか否かを判定するリトライ判定部と、を備えることを特徴とする帳票認識装置。【請求項2】  前記文字認識部によって算出される文字認識結果及び前記イメージ入力部によって取得された帳票画像の認識結果を記録する認識結果記録部と、  前記イメージ入力部によって入力された帳票画像を、前記認識結果データベースに記録された情報に基づいて、所定の条件を満たす帳票画像ごとに分類する帳票分類部と、を備えることを特徴とする請求項1に記載の帳票認識装置。【請求項3】  前記背景色分離部は、  前記押印画像検出部によって検出された前記押印画像の外接矩形の縦の長さと横の長さとを算出し、前記算出された縦の長さ及び横の長さのうち長い方の長さをLとし、kを予め設定された1より小さい正の実数とした場合に、前記押印画像の輪郭位置から距離kL以内に存在する画素を輪郭付近の画素として抽出し、  前記抽出された輪郭付近の画素のピーク色から色空間において予め設定された所定範囲の色を押印色として抽出し、  前記抽出された押印色の画素を押印部とし、その他の色の画素を背景部とすることを特徴とする請求項1に記載の帳票認識装置。【請求項4】  前記傾き補正部は、前記背景色分離部によって前記押印色が前記その他の色と分離された前記押印画像の輪郭よりも内側に存在する線分を検出し、前記検出された線分に基づいて前記押印画像の傾きを算出し、前記算出された押印画像の傾きを補正することを特徴とする請求項1に記載の帳票認識装置。【請求項5】  前記棄却判定部は、  前記知識処理部によって選択された文字認識結果に含まれる各文字の信頼度の和を当該文字認識結果に含まれる文字の数で除算することによって、当該文字認識結果の信頼度を算出し、  前記算出された文字認識結果の信頼度が所定の値よりも小さい場合には、前記知識処理部によって選択された文字認識結果を棄却することを特徴とする請求項1に記載の帳票認識装置。【請求項6】  前記棄却判定部は、前記知識処理部によって選択された文字認識結果が年月日を示す文字列である場合には、年を示す文字の信頼度、月を示す文字の信頼度、及び日を示す文字の信頼度に重み付けをして、前記文字認識結果の信頼度を算出し、  前記年を示す文字の信頼度の重み付けが最も低くされ、次いで前記月を示す文字の信頼度の重み付けが低くされ、前記日を示す文字の信頼度の重み付けが最も高くされることを特徴とする請求項5に記載の帳票認識装置。【請求項7】  同じ種類の押印画像のテンプレート画像である押印テンプレート画像と当該押印テンプレート画像に存在する文字の位置情報とを記憶する押印認識用辞書と、  前記押印認識用辞書を用いて、前記傾き補正部によって傾きが補正された前記押印画像の種類を特定する押印種特定部と、  前記押印認識用辞書を用いて、前記押印種特定部によって種類が特定された前記押印画像に存在する文字の位置情報を取得する文字位置特定部と、  前記傾き補正部によって傾きが補正された前記押印画像と、当該押印画像と同じ種類の押印テンプレート画像とを比較することによって、前記押印画像の劣化度を判定する劣化判定部と、をさらに備えることを特徴とする請求項1に記載の帳票認識装置。【請求項8】  前記押印認識用辞書には、前記同じ種類の押印画像の押印形状、押印サイズ、前記文字列の形式、前記文字列を構成する各文字の大きさ、及び前記押印色の少なくとも一つが記録され、また、前記押印テンプレート画像に存在する文字の位置情報として、前記押印テンプレート画像に存在する文字列の位置情報、及び前記文字列を構成する各文字の位置情報の少なくとも一つが記憶されることを特徴とする請求項7に記載の帳票認識装置。【請求項9】  前記押印種特定部は、位置Xの前記押印画像の画素値をp(x)とし、位置Xの前記押印テンプレート画像の画素値をq(x)とした場合に、｜p(x)−q(x)｜の値に応じて広義単調増加する関数K(p,q)の値が最小となる押印テンプレート画像の種類を、前記押印画像の種類として特定することを特徴とする請求項7に記載の帳票認識装置。【請求項10】  前記押印認識用辞書は、前記押印テンプレート画像に存在する文字列の位置情報、前記文字列を構成する各文字の位置情報、及び前記文字列の形式を記録し、  前記文字列探索部は、前記押印種特定部によって前記押印画像の種類が特定されている場合に、前記押印認識用辞書に記憶された前記文字列の位置情報に基づいて、前記傾き補正部によって傾きが補正された前記押印画像から文字列を探索し、  前記文字切出部は、前記押印種特定部によって前記押印画像の種類が特定されている場合に、前記押印認識用辞書に記憶された前記各文字の位置情報に基づいて、前記文字列探索部によって切り出された文字列を構成する文字を切り出し、  前記文字認識部は、前記押印種特定部によって前記押印画像の種類が特定されている場合に、前記劣化判定部によって判定された前記押印画像の劣化度に応じて文字認識方法を切り換え、  前記知識処理部は、前記押印種特定部によって前記押印画像の種類が特定されている場合には、前記文字認識部によって算出された文字認識結果のうち、前記押印認識用辞書に記憶された前記文字列の形式に適合する文字認識結果を選択することを特徴とする請求項7に記載の帳票認識装置。【請求項11】  前記劣化判定部は、位置Xの前記押印画像の画素値をp(x)とし、位置Xの前記押印テンプレート画像の画素値をq(x)とした場合に、｜p(x)−q(x)｜の値に応じて広義単調増加する関数K(p,q)の値を前記劣化度とすることを特徴とする請求項7に記載の帳票認識装置。【請求項12】  前記関数K(p,q)は、前記関数K(p,q)の値と、pとqを入れ替えた関数K(q,p)との値とが異なる非対称関数であり、  前記劣化判定部は、前記関数K(p,q)及び前記関数K(q,p)によって前記押印画像の前記押印テンプレート画像に対するつぶれ度及びかすれ度を算出することを特徴とする請求項11に記載の帳票認識装置。【請求項13】  押印を含む帳票を帳票認識装置に認識させる帳票認識方法において、  帳票を光学的に走査することによって得られた帳票画像を取得するイメージ入力ステップと、  前記イメージ入力ステップによって取得された帳票画像から押印画像を検出する押印画像検出ステップと、  前記押印画像の輪郭の色を示す押印色とその他の色とを分離する背景色分離ステップと、  前記背景色分離ステップによって前記押印色が前記その他の色と分離された前記押印画像の傾きを補正する傾き補正ステップと、  前記傾き補正ステップによって傾きが補正された前記押印画像から文字列を探索し、前記探索された文字列を切り出す文字列探索ステップと、  前記文字列探索ステップによって切り出された文字列から、前記文字列を構成する各文字を切り出す文字切出ステップと、  前記文字切出ステップによって切り出された各文字を認識し、前記文字列を構成するすべての文字を認識した結果を示す文字認識結果を算出し、前記認識された各文字の信頼度を算出する文字認識ステップと、  前記文字認識ステップによって算出された文字認識結果のうち、予め指定された文字列形式に適合する文字認識結果を選択し、前記選択された各文字認識結果に対する信頼度を前記文字認識ステップによって算出された各文字の信頼度に基づいて算出する知識処理ステップと、  前記知識処理ステップによって選択された文字認識結果と当該文字認識結果の信頼度とに基づいて、前記知識処理ステップによって選択された文字認識結果を棄却するか否かを判定する棄却判定ステップと、  前記棄却判定ステップによって前記文字認識ステップによる文字認識結果が棄却された場合に、押印画像の文字を再度認識させるか否かを判定するリトライ判定ステップと、を備えることを特徴とする帳票認識方法。【請求項14】  前記帳票認識方法は、  前記文字認識ステップによって算出される文字認識結果及び前記イメージ入力ステップによって取得された帳票画像の認識結果を記録する認識結果記録ステップと、  前記イメージ入力ステップによって入力された帳票画像を、前記認識結果データベースに記録された情報に基づいて、所定の条件を満たす帳票画像ごとに分類する帳票分類ステップと、を有することを特徴とする請求項13に記載の帳票認識方法。【請求項15】  前記帳票認識装置は、同じ種類の押印画像を押印テンプレート画像と当該押印テンプレート画像に存在する文字の位置情報とを記憶する押印認識用辞書を備え、  前記帳票認識方法は、  前記押印認識用辞書を用いて、前記押印画像検出ステップによって検出された前記押印画像の種類を特定する押印種特定ステップと、  前記押印認識用辞書を用いて、前記押印種特定ステップによって種類が特定された前記押印画像に存在する文字の位置情報を取得する文字位置特定ステップと、  前記押印画像検出ステップによって検出された前記押印画像と当該押印画像と同じ種類の押印テンプレート画像とを比較することによって、前記押印画像の劣化度を判定する劣化判定ステップと、を有することを特徴とする請求項13に記載の帳票認識方法。
帳票認識装置及び帳票認識方法
