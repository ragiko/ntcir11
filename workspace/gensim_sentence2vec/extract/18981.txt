ニコニコ動画ではFlash Playerで動画再生します。なのでFlash Playerで正常に再生出来る動画にエンコードする必要があります。x264の設定次第では環境によって見た目が違う(映像が崩壊したり色が違う)、またシークが出来ないなどと言った事もあり得るのでそういう面で注意すべき設定箇所のみピックアップしてAviUtlの拡張x264(GUI)Exプラグインver1.42でのスクショ付きで解説を。拡張x264guiEXで出力出来る環境がない、これから作る人はaviutl_h264 - ニコニコ動画まとめwikiを参考に道入してみてください。下記の問題を回避した個人的なオススメ設定ファイルを作成し配布してます。必要な方はDLしてください。※最終更新2013/04/02x264guiEx設定ファイル※この設定はアニメ系の動画エンコードに適した設定で実写系だとあまりよくならないかもしれないので、その時には設定をカスタマイズするか元々入ってるプロファイルを使う、またはつんでれんこの設定をAviUtl用に作ったファイルを金の髭さんが配布(つんでれんこ v2.71のx264設定を、拡張x264(GUI)Ex v1.43用の設定ファイルにしてみた)してるのでそちらを使用するといいと思います。長くなるので追記から
まずはビットレートについて※画像クリックでちょっとだけ拡大して見やすくなります。自動マルチパスでのビットレート指定でエンコードするモード基本的にこのモードは目的のファイルサイズやビットレートにしたい時に使用します。例えば一般会員の40MBや656kbpsというファイルサイズやビットレート上限、またエコノミー回避の445kbpsの制限、長時間動画の場合のプレミアム会員の100MBといった物をクリアするのが精一杯な場合にはこのモードでギリギリ目指してエンコードするといいかと。上限ファイルサイズや上限ファイルビットレートのチェックボックス使った設定等は必要であれば適時調整を。このプラグインの設定画面右上に簡易ビットレート計算機もあるのでそちらを使用して計算するのもアリそしてビットレートでなく品質指定してエンコードするモードについてシングルパス-品質基準VBR(可変レート)【--crf】これは目的の品質にしたい時に使用します。ビットレート指定でのエンコードの違いはビットレート指定してそれに合わせて画質が変化するのか、画質を指定してビットレートが変化するのかの違いです。ニコニコ用エンコードではプレミアム会員で10分以内の動画(動きが激しすぎる物や高解像度の物はもっと短いかも)等でファイルサイズ上限は特に気にしなくても良さそうな場合や、目的の品質にする場合にだいたいどれくらいのビットレートが必要なのかを調べるのに有効です。この品質指定の値の目安は18から24程度、俺は基本的に23程度でやってますがソースによっては画質の荒れが気になったりする事もあると思うのでその時は数値調整を。この数値は少ない程高画質で高ビットレートになりますが18より小さい数値にしてもおそらく見た目で違いを感じる事は殆ど無いかと。このビットレートが決まる部分について大事なポイントは画質に満足出来るギリギリのラインまでビットレートを削ってやることです。軽い動画の方がいいのは間違い無いですので。そして次にcolormatrixの指定【--colormatrix】ここは「smpte170m」を指定これと合わせてAviUtlの本体の設定色変換の設定の出力をBT.601にハードウェアアクセラレーション有効時11.2まではcolormatrixを無視、解像度に関わらず強制的にBT.601でデコードする11.3ではハードウエアアクセラレーションオフの時と同様、colormatrixの設定を解釈し、colormatrixが無い場合は解像度に関わらず強制的にBT.709でデコードするハードウェアアクセラレーション無効時Flash Player11.2以外ではcolormatrixの設定を解釈し、colormatrixが無い場合は解像度に関わらず強制的にBT.709でデコードするFlash Player11.2ではハードウエアアクセラレーション有効時と同様、colormatrixを無視、解像度に関わらず強制的にBT.601でデコードする上記をふまえた場合、どんな環境でも正しく色表示するにはBT.601でエンコードし、colormatrixをsmpte170m指定するしか方法がありません。現状の最新バージョンの11.2では特に指定の必要はないですが、まだ10.3系を使用してる人もいますしFlash Playerの仕様変更によってまた変化があるかもしれないので正しく表示されるように指定しておくのが望ましいです。11.3ではハードウエアアクセラレーションオンオフに関わらず未指定だとBT.709でデコードされるので、確実に正しく指定しておく必要があります。詳しくはコチラ:拡張 x264 出力(GUI)Exの設定項目とその機能について実際に未指定でエンコードしたサンプル動画がこちら【色空間テスト】BT.601出力を--colormatrix無しでエンコした間違いMP4動画ページに飛べばそこから正しく指定されたものへもリンクされています。BT.601で出力し--colormatrixを正しく指定した物と指定なしの場合の見え方サンプル大きく変わっちゃうのが赤と緑ですかね。赤が朱色っぽく、緑がくすんだ感じになってしまいます。そしてフレームタブ内の設定参照距離【--ref】ここは絶対に16にしないように16にすると環境によって派手に映像が崩壊します。再生負荷が高まる等、色々不具合が出るので絶対にしないように。再生負荷やエンコード速度、画質等を考慮すると多くても6程度に抑えておくのがいいかと。参考動画がおかしくなる方は大百科をクリック - ニコ百映像崩壊する物をキャプったサンプル。こんな風になります【ニコニコ動画】【キャプチャ】ニコエンコ変換とIntelチップバグ sm16620105キャプった元の動画はコチラ【ニコニコ動画】比較5(一般・最低速30fps)ニコエンコ変換とIntelチップバグ検証用(中程度)元のを見て映像が崩壊してる場合は画面右クリックから設定ハードウエアアクセラレーションを有効化のチェックを外して再読み込み後視聴すれば正常な映像が見れます。※視聴後は特に理由がない限り有効化のチェックを元に戻しておく事最大連続Bフレーム数【--bframes】ここはrefと同様、上げすぎると再生負荷が高くなったりする上に、環境によっては映像が荒れる要因になる可能性もゼロではないので上げ過ぎないようにする方がいいと思います。自分でエンコードする時は6までなら日常的に使ってますし、特に重すぎたり映像の荒れがある等はなさそうなのでその辺を目安に設定するといいかもしれません。キーフレーム間隔の下限【--min-keyint】0で自動になるので特にこだわらないなら0にしてそのまま放置でいいと思います。他の値を指定する場合は設定の意味を理解した上でする事。キーフレーム間隔の上限【--keyint】ここは動画のfpsの値によってしっかり設定を変えるべし。x264guiEx 1.43から-1を指定するとfpsの10倍の値が自動で指定されるようになったので−1推奨。他の値を指定する場合は設定の意味を理解した上でする事。-1が指定出来ない場合はバージョンが古いと思うのでバージョンアップを基本的にfpsの10倍の値(30fpsなら300)がよく使われるしバランスがいいと思います。この値を常にデフォルトの250にしてるとfps=1の静止画動画をエンコードした場合に250秒間シーク出来ない動画が出来上がってしまったり、60fpsの動画をエンコードするとキーフレームが多目になってビットレート軽減するのが厳しくなったりします。ビットレート上限やファイルサイズ上限ギリギリの時等でシーク間隔広くなるのは覚悟の上でビットレートを削りたい場合はfpsの15倍程度まで増やすとビットレート節約出来ていいかも※AviUtlに読み込んでる動画のfpsを調べる方法1.AviUtlのメインウインドウのその他ファイルの情報を開き、フレームレートの所を見る。2.プラグイン出力拡張x264出力(GUI)Exからファイル名を付けて保存する画面で確認。この2個の方法が手っ取り早いのでオススメインループ デブロックフィルタ【--deblock】これをオンにしてるとハードウエアアクセラレーションオフの場合にブロックノイズが大量発生する事があります。サンプルがこれ【ニコニコ動画】【FlashPlayer映像崩壊】デブロック有効時のサンプル同じシーンをハードウェアアクセラレーションON・OFFで見たスクリーンショット綺麗に見える人は動画プレイヤー上で右クリック設定ハードウエアアクセラレーションを有効化のチェックを外して再読み込み視聴すると再現されるはず※ここも特に理由がない限り視聴後は有効化のチェックを元に戻しておく事放射状のグラデーションで明暗の変化がある動画、灰色や肌色な感じの色のフェードイン等で特に発生しやすいようです。ハードウエアアクセラレーションが効いてる状態で動画視聴してる人にはこの症状が発生しても全く問題ないですが、この症状が発生してる動画をハードウエアアクセラレーションが効かないPCで視聴する際に綺麗に見えるようにしようとすると動画をDLしてFlash Playerでないものでデコードするしか方法がなくなります。そのハードウエアアクセラレーションが効かないPCで視聴してる人も現状たくさんいますので症状回避に務めるようにしましょう。これを常にオフにするのもアリですがメリット・デメリットを把握した上で判断するように。オフ時のメリット:これが原因のブロックノイズが発生しない、再生負荷がちょっとだけ軽くなる。    デメリット:少しだけだが、ビットレート増加、画質劣化回避する方法:チェックオフ【--no-deblock】にする。オンにする場合は発生してない事をしっかり確認する事。deblockを使用したエンコード後の動画でこの症状が発生してるかどうかをチェックするにはFlash Playerでハードウエアアクセラレーションが効いてない状態で視聴する必要があり。自分のPCが先程の動画でどういう条件なら症状が発生するのかを把握し、それと同条件で動画確認する事。※ハードウエアアクセラレーションのオンオフの設定が可能でFlash Player再生出来る物はつんでれんこ、夏蓮根に付属されてる「MP4」フォルダ内の「ここにD&Dして動画をチェック.bat」があります。そしてこのツールのみで配布もされてます。つんぷれhttps://bitly.com/NxoOFK重み付きPフレーム【--weightp】ここはSmart【--weightp=2】は使用しない方がいいです。使用するならSimple【--weightp=1】でこれも環境次第ではデコードが壊れる事があるようですがサンプルが見つからないのでしない方がいいよという注意喚起のみで。※ここのサンプル等ありましたら連絡頂けると助かります。現状のFlash Playerで再生するニコニコではこの設定をしっかりしておけば自分が見てる物と他の皆が見てる映像が同じ物になるので、あとは高画質低容量低負荷になるようにそれぞれの設定を調整して最適な物にすれば大丈夫です。上記の設定の詳しい解説や他の設定箇所の参考サイト:拡張 x264 出力(GUI)Exの設定項目とその機能についてその設定の調整が分かりにくい場合には拡張x264(GUI)Exにあるプリセットを使用し、上記設定のポイントに注意して設定を調整すれば比較的簡単に良い結果が得られると思います。ちなみにここで説明した物の内ビットレート設定とデブロックフィルタ以外の全てはつんでれんこでエンコードすれば勝手に設定されます。夏蓮根のアニメ用プリセットならデブロックフィルタについても回避される設定になってる上に、品質基準VBRのモードでエンコードするプリセット「t」もあります。なのでここに書いてある事の理解が難しいようならつんでれんこや夏蓮根推奨。10分以内程度の短時間動画ならプリセット「t」が凄く便利なのでつんでれんこより夏蓮根オススメです。ニコエンコは非推奨つんでれんこのお部屋つんでれんこ まとめ wiki - 夏蓮根ニコエンコを推奨しない理由についてはニコエンコの大百科と金の髭さんのブログで解説されてるのでそちらへニコエンコ v0.77を使う場合の注意点: さまよう金の髭ニコエンコ - ニコ百出来上がった動画のチェックはうp前の動画チェック方法について にあるようにFlash Playerで再生するように。5/25 20:00 x264guiExのバージョンアップによりキーフレーム間隔の上限の推奨設定が変わったので修正6/11 22:00 FlashPlayer11.3にて仕様変更があったのでその部分(--colormatrix)について追記
x264でのニコニコ動画用エンコードで注意すべき設定(AviUtl) - パラダイス☆ケンジ
