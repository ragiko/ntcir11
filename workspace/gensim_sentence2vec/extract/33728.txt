
4   トランザクションの管理
この章では、トランザクションを定義し、トランザクションを使用して作業を管理する方法について説明します。 
この章の内容は、次のとおりです。
トランザクションの概要
トランザクション管理の概要
自律型トランザクションの概要
トランザクションの概要
トランザクションは、1つ以上のSQL文を含む論理作業単位です。トランザクションはアトミック(基本)な単位です。つまり、トランザクション内のすべてのSQL文は、すべてコミット(データベースに適用)されるか、すべてロールバック(データベースから取消し)されるかのどちらかになります。 
トランザクションは、最初の実行可能なSQL文から開始します。トランザクションは、COMMIT文またはROLLBACK文を使用して明示的に、またはDDL文を発行して暗黙的にコミットまたはロールバックされた時点で終了します。 
トランザクションの概念を具体的に説明するため、銀行業務データベースについて考えてみます。銀行の顧客が普通預金口座から当座預金口座へ預金を振り替える場合、トランザクションは次の3つの別々の操作で構成されます。
普通預金口座の減額
当座預金口座の増額
トランザクション・ジャーナルへのトランザクションの記録
Oracle Databaseでは、2つの状況が考慮されます。3つのSQL文がすべて実行されて、口座の差引残高の帳尻が合えば、トランザクションの結果をデータベースに適用できます。ただし、預金額の不足、口座番号が無効、またはハードウェア障害などの問題が原因で、トランザクション内の1つまたは2つの文が完了しない場合は、すべての口座の差引残高が正しく維持されるようにトランザクション全体をロールバックする必要があります。
図4-1に銀行のトランザクションの例を示します。 
図4-1    銀行のトランザクション
画像の説明
この項の内容は、次のとおりです。
文の実行とトランザクションの制御
文レベルのロールバック
再開可能領域割当て
文の実行とトランザクションの制御
正常に実行されるSQL文とコミットされるトランザクションとは異なります。正常に実行されるとは、単一の文が次の条件を満たしたことを意味します。
解析されたこと。
有効なSQL構文であることが確認されたこと。
アトミックな単位としてエラーなしで実行されたこと。たとえば、複数行の更新ですべての行が変更された場合などです。 
ただし、その文が含まれているトランザクションがコミットされるまでは、トランザクションをロールバックしてその文のすべての変更を取り消せます。正常に実行される(成功する)という表現は、トランザクションではなく、文に対して使用します。 
コミットとは、ユーザーが明示的または暗黙的に、このトランザクションの変更内容を確定するように要求することを意味します。明示的な要求は、ユーザーがCOMMIT文を発行すると発生します。暗黙的な要求は、アプリケーションの正常終了後またはデータ定義言語(DDL)操作の完了後に発生します。トランザクションがコミットされて初めて、トランザクションのSQL文による変更内容が確定され、他のユーザーがこれらの変更を参照できるようになります。トランザクションのコミット後に発行された問合せでは、コミットされた変更を参照できます。
トランザクションを開始する前に、SET TRANSACTION ... NAME文を使用して、トランザクションに名前を付けることができます。名前を付けることで、長時間実行のトランザクションの監視およびインダウト分散トランザクションの解決が容易になります。
文レベルのロールバック 
実行中にSQL文のエラーが発生すると、その文のすべての効果はロールバックされます。ロールバックの効果は、その文がまったく実行されなかった場合と同じ状態にすることです。この操作が文レベルのロールバックです。
SQL文の実行中にエラーが検出されると、文レベルのロールバックが発生します。この種のエラーの一例として、主キーに重複値を挿入しようとした場合があります。1つのデッドロック(同じデータに関する競合)に単一SQL文が複数関係している場合も、文レベルのロールバックが発生します。解析中に構文エラーなどのエラーが検出された場合は、まだSQL文は実行されていないため、文レベルのロールバックは発生しません。
SQL文でエラーが発生した場合は、SQLでの実行予定の作業のみが影響を受けます。現行のトランザクションにおけるこれまでの作業に影響を及ぼすことはありません。文がDDL文の場合、その文の直前に実行された暗黙的コミットは取り消されません。 
再開可能領域割当て
Oracle Databaseでは、領域割当てエラーが発生した場合、大規模なデータベース操作の実行を一時停止および再開することが可能です。このため、Oracleデータベース・サーバーからユーザーにエラーを戻すかわりに、管理者は対処措置を取ることができます。エラー条件が修正されると、一時停止中の操作が自動的に再開されます。 
再開可能モードで文が実行されるのは、クライアントがALTER SESSION文を使用して、明示的にセッションの再開可能セマンティクスを使用可能にした場合のみです。
次のような場合、再開可能領域割当ては一時停止されます。
領域が足りない場合
エクステントの最大値に達した場合
領域割当て制限を超えた場合
非再開可能領域割当ての場合、これらの条件ではエラーが発生し、文がロールバックされます。
文を一時停止すると、トランザクションが自動的に一時停止されます。このため、トランザクションのすべてのリソースが、一時停止文および再開文を介して保持されます。
エラー条件が(たとえば、ユーザーの介入、または他の問合せによりソート領域が解放された結果として)消滅すると、一時停止中の文が自動的に実行を再開します。
トランザクション管理の概要
Oracle Databaseでのトランザクションは、最初の実行可能SQL文が検出された時点で開始されます。実行可能SQL文は、DML文やDDL文など、インスタンスへのコールを生成するSQL文です。 
トランザクションが開始されると、Oracle Databaseはそのトランザクションを使用可能なUNDO表領域に割り当てて、新しいトランザクションのロールバック・エントリを記録します。
トランザクションは、次のいずれかの状況が発生すると終了します。
COMMIT文またはROLLBACK文が、SAVEPOINT句なしで発行される場合。 
CREATE、DROP、RENAMEまたはALTERなどのDDL文が実行される場合。カレント・トランザクションにDML文が含まれている場合、Oracle Databaseは最初にそのトランザクションをコミットし、新しい単一文トランザクションとしてそのDDL文を実行し、コミットします。 
ユーザーがOracle Databaseの接続を切断する場合。カレント・トランザクションはコミットされます。
ユーザー・プロセスが異常終了する場合。カレント・トランザクションはロールバックされます。 
1つのトランザクションが終了すると、次の実行可能SQL文によって次のトランザクションが自動的に開始されます。
この項の内容は、次のとおりです。
トランザクションのコミット
トランザクションのロールバック
トランザクションのセーブポイント
トランザクションの命名
2フェーズ・コミット・メカニズム
トランザクションの管理
