Ubuntu PCをルータ代わりにして、新しくLANを構築してみる
以下のような構成のLANを手早く作りたい、という場面が時々あります。
既存のLAN(192.168.1.0/24)
ルータ1新しく作るLAN 1(192.168.200.0/24)
ルータ2新しく作るLAN 2(192.168.201.0/24)
クリアコードはOSSの導入サポートも行っていますので、クリーンな検証用環境としてこのような構成のネットワークを新たに用意して作業をする、という事がよくあります。今回は、新たなネットワーク機器を購入せずに普通のPCを組み合わせてこのようなネットワークを構築する方法を紹介したいと思います。
前提
現時点では既存のLANのみがあり、そこに新たに2つのLANを別々に構築して冒頭のような構成にしたい、という状況にあるとします。
既存のLANはルータを介して既にインターネットに繋がっている。
新しく作る2つのLANからもインターネットに繋がるようにしたい。
本格的に長期に渡って運用するつもりはなくて、あくまで、2つのLANにまたがる作業の実験・検証用のネットワークとして使いたい。
既存LANのルータの設定はいじりたくない。
実運用するネットワークであれば専用にルータ機器を導入するところですが、単に実験・検証用の環境にするだけなら、既存の機材でやりくりして同様の環境をエミュレートできれば十分な場合がほとんどです。
そこで今回は、Ubuntu 10.10がインストールされていて既存のLANに接続されているPC 1台を適切に設定して、新しいLAN2つと既存のLANの間で動作するルータ兼サーバとして動作させることによって、冒頭のような構成のネットワークを構築しようと思います。
必要な作業
今回の作業は4つのステップに分ける事ができます。
LAN用のインターフェースを3個持っていて既存のLANに既に繋がっているPC 1台と、新しいPC 2台を使って、新しいLANを2つ構築する。
既存のLANに繋がっているPCをDHCPサーバにする。これによって、新しいLANに所属する事になる各コンピュータのIPアドレスを自動的に決めさせる事ができる(いちいちIPアドレスを自分で決めなくてもよくなる)。
既存のLANに繋がっているPCにルータの働きをさせる。これによって、新しいLANからもインターネットに繋がるようになる。
既存のLANに繋がっているPCをDNSにする。これによって、新しいLANに所属するPCが「www.example.com」のようなホスト名を名前解決できるようになる(Webブラウザ等を普通に使えるようになる)。
用意したもの
既にインターネットに繋がっている、構築済みのLAN 1つ
Ubuntu 10.10をインストール済みのPC 1台
無線LANインターフェース(wlan0)と有線LAN用インターフェース(eth0)の2つを持っている。
既存LANには無線LANで接続している。
USB接続のLANアダプタ
Ubuntu PCにもう1つLAN用インターフェース(eth1)を加えるために使う。
CentOS 5.5をインストール済みのPC 2台(せんとくん1号、せんとくん2号)
新しく構築するLANに所属する予定のコンピュータ。
OSはUbuntuでもWindowsでも構わない。今回はたまたまCentOSというだけ。
CentOSはGnomeも入れてデスクトップ環境で操作できるようにしてある。
どちらも有線LAN用インターフェース(eth0)を持っている。
できる予定のネットワークの構成
冒頭の構成に基づいて、最終的に以下のようなネットワークにしたいと思います。
192.168.1.0/24
wlan0
[Ubuntu PC]eth0192.168.200.0/24[せんとくん1号]
eth1192.168.201.0/24[せんとくん2号]
ネットワークの基礎知識を押さえておこう
「192.168.1.0/24」って何? どういう意味?
先の図では特に説明もせず「192.168.1.0/24」という風な表記を使いましたが、この表記が何を意味しているか分かりますか?(分かる場合はこの節を読み飛ばして構いません。)
「192.168.1.0/24」は、そこに接続しているコンピュータのIPアドレスの範囲が 192.168.1.1〜192.168.1.254 であるコンピュータ同士のネットワーク(LAN)を指しています。
IPv4の世界では、ネットワークに接続する全てのコンピュータに一意なアドレスが与えられ、そのアドレスで個々のコンピュータを識別します。これが「IPアドレス」です。IPv4ではIPアドレスは「0〜255の数字がドット区切りで4つ並んだ数列」で表現されていて、例えば「127.0.0.1」や「192.168.1.1」や「66.249.89.104」といったものもIPアドレスです。
このIPアドレスを2進数で表すと、例えば
192.168.1.0
192.168.1.255
66.249.89.104
というアドレスはそれぞれ
11000000.10101000.00000001.00000000
11000000.10101000.00000001.11111111
01000010.11111001.01011001.01101000
になります。
この時、上の2つのアドレスは先頭から24桁目までが一致していますよね。このような場合に「24桁目までが一致しているアドレスの範囲を1つのLANとして扱う」という意味の表記が、前出の「/24」です。
ですから、「192.168.1.0/24」のLANならIPアドレスの範囲は192.168.1.0〜192.168.1.255の256個ですし、「172.16.100.0/24」のLANならIPアドレスの範囲は172.16.100.0〜172.16.100.255の256個ということになります。また、24桁ではなく16桁までが一致している範囲を1つのLANとして扱うのなら、「192.168.0.0/16」という表記で192.168.0.0〜192.168.255.255までの65536個のIPアドレスの範囲が1つのLANになります。
さて、「頭から24桁目までが一緒であればそれを1つのLANとする」というルールを、数字でどうやって表せばよいでしょうか。そのまま「/24」と書く事もできますが、別の表現方法もあります。例えば「2進数で値が1になっている部分が一緒であればそれを1つのLANとする」という取り決めにすれば、2進数で「11111111.11111111.11111111.00000000」と書くことになります。これを10進数に直すと「255.255.255.0」になり、このように、ネットワークの範囲を決定する情報をIPアドレスと同じ形式で表記した物を、サブネットマスクと呼びます。
以上の事から、世間でたまに見かける
192.168.1.0/24
192.168.1.0/255.255.255.0
ネットワークアドレス 192.168.1.0、サブネットマスク255.255.255.0
という風な表記は全て、実際には同じ事を言い表していると分かります。
なお、「192.168.1.0/24」というLANなら192.168.1.0から192.168.1.255までの256個のアドレスが存在することになりますが、その範囲の最初のアドレスである「192.168.1.0」はそのネットワーク自体を表すアドレスとして使われて、最後のアドレスである「192.168.1.255」は「そのアドレス宛に送られたメッセージは、ネットワークに属している全てのコンピュータが受け取る」という「ブロードキャストアドレス」として使われます。なので、実際にそのLANでコンピュータに割り振れるアドレス(LANに所属できるコンピュータの最大数)は、192.168.1.1から192.168.1.254までの254個ということになります。
1台のコンピュータが複数のIPアドレスを持つ事もある
IPアドレスはネットワーク上にあるコンピュータを識別するためのアドレスで、普通にLANに接続する場合ならコンピュータ1台につきIPアドレスは1つというのが一般的ですが、場合によっては1台のコンピュータが複数のIPアドレスを持つ場合もあります。ルータはその代表例です。
2つのLANにまたがって存在するルータ(あるいはルータの代わりをするPC)は、それぞれのLAN用のIPアドレスを持つ事になります。無線LANのインターフェース(wlan0)で192.168.1.0/24の方に繋がっていて、有線LANのインターフェース(eth0)で新しいLAN(192.168.200.0/24)の方に繋がっているのであれば、
wlan0
接続先のネットワーク:192.168.1.0/24
自分のIPアドレス:192.168.1.100
eth0
接続先のネットワーク:192.168.200.0/24
自分のIPアドレス:192.168.200.100
といった要領です。
目標の再確認
以上を踏まえると、先程構築したいネットワークの構成として挙げた
既存のLAN(192.168.1.0/24)
ルータ1新しく作るLAN 1(192.168.200.0/24)
ルータ2新しく作るLAN 2(192.168.201.0/24)
は、
既存のLAN(192.168.1.0/24)
(192.168.1.0のネットワークで、192.168.1.1〜192.168.1.254の
254台のコンピュータが存在しうる)
ルータ1新しく作るLAN 1(192.168.200.0のネットワークで、
192.168.200.1〜192.168.200.254の254台の
コンピュータが存在しうる)
ルータ2新しく作るLAN 2(192.168.201.0のネットワークで、
192.168.201.1〜192.168.201.254の254台の
コンピュータが存在しうる)
という意味だということが分かります。
今回はUbuntu PC1台でルータ1とルータ2を兼用するので、それぞれのLANに接続するインターフェースを考慮に入れると
192.168.1.0/24
wlan0(IPアドレス:192.168.1.100)
[Ubuntu PC]ルータ1用に使うeth0(IPアドレス:192.168.200.254)
192.168.200.0/24
ルータ2用に使うeth1(IPアドレス:192.168.201.254)
192.168.201.0/24
という構成になります。
1. LANを構築する
それでは実際の作業としてまず、Ubuntu PCとせんとくん1号2号の間でLANを組む所から入りましょう。
Ubuntu PCに固定IPを割り当てる
普通に構築済みのLANでクライアントとしてUbuntuを使用する場合、IPアドレスはそのLANのDHCPサーバによって割り当てられた適当な物が使われます。しかし、今回構築するLANではこのUbuntu PC自身をサーバ兼ルータとして使用することになりますので、IPアドレスは新LAN用の物を固定で割り当てておかないといけません。
固定IPの割り当てはUbuntuのネットワークマネージャでも可能ですが、後の項でネットワークマネージャではできない設定を施す必要がありますので、今回はより低レベルな設定用のインターフェースとして、ネットワーク接続の設定ファイル /etc/network/interfaces を直接編集することにします。
これから施す設定は、
eth0に固定のIPアドレス 192.168.200.254 を割り当てる
192.168.200.0/24系のネットワークであると設定する
eth1に固定のIPアドレス 192.168.201.254 を割り当てる
192.168.201.0/24系のネットワークであると設定する
というものです。
/etc/network/interfaces は、使用したUbuntu PCの元の状態では以下のようになっていました。
Ubuntu PCをルータ代わりにして、新しくLANを構築してみる - ククログ(2010-11-19)
