
SUMIF、COUNTIF関数は、条件にあったものだけを集計したり、
件数を数えたりする場合に非常に便利な関数ですが、ちょっと
よくばって2つ以上の条件で集計しようとすると、とたんに困って
しまいます。
それは、これらの関数が2つ以上の条件に対応できないことに起因します。
そんなとき、「配列数式」を用いるとうまく処理できます。
例えば、以下のような場合を考えます。
ここで、A列が 女、B列が 20以上 のデータ件数を求めたいとします。
その場合、いったん結果を表示させたいセルをクリックしておいてから、
上部の数式バーに、=SUM(IF(A2:A8="女",IF(B2:B8>=20,1,0))) と入力し、
[Shift]+[Ctrl]+[Enter] で確定します。
以上のようにして式を確定すると、表示は{=SUM(IF(A2:A8="女",IF(B2:B8>=20,1,0)))}
と変化します。式の両側に{}(中かっこ)がつくことで配列数式になったことが確認できます。
そして結果を求めるセルには 2 と表示され、該当件数は2件であることがわかります。
IF関数は、ご承知のように記述部分が3つのパートに分かれていて、最初の部分に条件式を記入し、
次の部分は条件が満たされたときの処理を、最後の部分は条件に合わなかった場合の処理を記述します。
したがって、2つのIF関数の条件にあった場合は数値の1が返され、条件に合わないセルには0が入りますので、それをSUM関数で合計することでカウントと同じ結果を得る仕組みに
なっています。
また、合計値を求める場合は、1 の変わりにB列の範囲を指定します。
例 {=SUM(IF(A2:A8="女",IF(B2:B8>=20,B2:B8,0)))}
このようなことは、オートフィルタやフィルタオプションでもできなくはないですが、
毎回複数の操作が必要だったり、別な場所に条件設定のためのエリアが必要だったりと
すっきりいきません。
計算式や関数で、参照データの範囲指定をしなければいけないとき、
「あとでデータが増えるかもしれないな」と思うことがありませんか?
そんなとき、現在のデータで範囲指定をしてしまうと、データの追加があるたびに
範囲指定をやり直さなければいけなくなってしまいます。(途中に挿入する場合は問題ありませんが)
こういう場合、セル番地ではなく列名だけを範囲として与えてやることで
その後のデータ追加に対応できることがあります。
例えば、A列のA1からA8にデータが入っており、それにたいしてMAX関数で
最大値を求めなければいけないようなとき、通常は=MAX(A1:A8)とします。
この場合は、もしデータがA9に追加されると、その都度に範囲を
=MAX(A1:A9)と書き換えてやらなければいけなくなります。
そこで、=MAX(A:A)のように列名だけを範囲情報として与えてやると、データがたびたび
最後に追加されても問題なく計算してくれるようになります。
ただし、計算式および関数はA列以外の場所に入れる必要があります。
一行おきに入力された「後期得点」だけを合計するとします。
「後期得点」について、
シートの行番号を基準に見ていくと、3行目、5行目、7行目・・・のように、奇数の行ごとに
入力されています。ということは、得点が入ったセルの行番号を調べ、奇数なら得点の値を
別セルに取り出し、それを足し合わせれば「後期得点」を求めることができることがわかります。
そこで、まずROW関数を使ってセルの行番号を調べます。「=ROW()」という式を入力すると、その式が
入力されているセルの行番号がわかります。 
行番号が奇数かどうか調べるには、行番号を「2」で割って余りを求め、これが「1」なら
奇数と判定します。ある数値を「2で割った余り」を調べるには、MOD関数を使い、
「MOD(ROW(),2)」という式を組み立てると判定できます。 
こうして求めた値が「1」なら、D列に数値を取り出し、「1以外」なら空欄とします。
場合分けには、IF関数を使います。D3セルの式では、「条件式」を「MOD(ROW(),2)=1」
(行番号を2で割った余りが1である)とし、1のときB3セルの内容をD3に、1でないとき空欄""を
D3に出力するようにしています。こうして取り出したD列の得点をSUM関数で合計すれば完成です。 
どうしても別の列を使いたくなければ「複数の条件を設定したいとき」で紹介した配列数式を用います。
以下のように数式を入力し、Ctrlキーと Shiftキーを押しながら Enterキーを押します。
=SUM(IF(MOD(ROW(B2:B9),2)=1,B2:B9))
{=SUM(IF(MOD(ROW(B2:B9),2)=1,B2:B9))}
式の両側に{ }(中かっこ)がつくことで配列数式になったことが確認できます。
この式の意味は、まずB2からB9の行番号をROW関数で取り出し、それぞれを2で割った余りを求めていきます。
余りが1かどうかをIF関数で判定し、1のセルのみをSUM関数で合計することで求めたい結果がでます。
よく割り算の式を立てていて、分母に当たるセルの値がたまたま0になったとき、エラーになって
しまうことがあります。この場合のように0のときには空欄、もしくは別な表示をさせたいとき、
ISERROR関数が便利です。
ISERROR関数は、引数(カッコの中)に指定した計算式にエラーがないかどうか調べる時に使うもので、
IF 関数といっしょに使えます。
例えば、計算結果がエラーであれば空白を表示し、エラーでなければ計算結果を表示したいという場合には、
以下のような式を立てることになります。
=IF(ISERROR(計算式),"",計算式)
例で示すと、
上の図で、そのままA列をB列の値で割っていくと、4行目と7行目で「#DIV/0!」のエラーになってしまいます。このとき
=IF(ISERROR(A2/B2),"",A2/B2)という式にすることで、エラーになることを回避することができます。
これは、ISERROR(A2/B2)関数の実行結果がエラーである場合、TRUE(真)の戻り値が返ってくるので、IF関数の
左側の部分("")が実行され、エラーで無い場合は右側の部分(A2/B2)が実行されるためです。
作成したExcelの表を、自分ではなく他の人に使ってもらわなければいけないとき、せっかく入力した計算式を
誤って消されてしまわないか、不安なときがあります。このようなとき、特定のセルにだけ保護をかけることができます。
以下の順で操作を行ってみてください。
まず、すべてのセルのロックを解除。
(ワークシートの初期設定では、すべてのセルに[保護]の[ロック]がかかっています。)
(1)[全セル選択] ボタン(ワークシートの行番号と列番号が交差している部分)をクリック。
すべてのセルが選択される。
(2)メニューの [書式(O)]−[セル(E)] をクリックし、[保護] タブをクリック。
(3)[ロック(T)] チェック ボックスをオフにする。
(4)[OK]ボタンをクリック。
次に数式が入力されているセルを選択。
(1)メニューの [編集(E)]−[ジャンプ(G)] をクリック。
[ジャンプ]ダイアログボックスが表示される。
(2)[セル選択(S)]ボタンをクリック。
(3)[選択オプション]で[数式(F)]を選択し、[OK]ボタンをクリック。
これで数式の入力されているセルすべてが選択される。
最後に選択されているセル範囲にロックを設定する。
(1)メニューの [書式(O)]−[セル(E)] をクリックし、[保護] タブをクリック。
(2)[ロック(T)] チェック ボックスをオンにする。
(3)[OK]ボタンをクリック。
(4)メニューの [ツール(T)]−[保護(P)] をポイントし、[シートの保護(P)] をクリック。
(5)他のユーザーが保護を解除できないようにするには、[シート保護]ダイアログボックスの[パスワード]テキストボックスにパスワードを入
力し、[OK] をクリックして [パスワードの確認(R)] ダイアログボックスにもう一度パスワードを入力。
(6)[OK]ボタンをクリック。
パスワードでは、大文字と小文字が区別されるので、大文字と小文字を区別
し、指定したパスワードを正確に入力する。
以上で、本人以外誰も計算式を変更することができなくなります。
Excel小技集(Office Boole)
