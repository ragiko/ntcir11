問合せオプティマイザの目的
オプティマイザは、SQL文の最適な実行計画の生成を試みます。最適な実行計画とは、考えられるすべての計画の候補中で最もコストの低い計画と定義されます。コスト計算によって、問合せ実行の要素(I/O、CPU、通信など)が明らかになります。
最適な実行方法は、問合せがどのように記述されているか、データセットのサイズ、データのレイアウト、存在するアクセス構造など、様々な条件によって異なります。オプティマイザは、複数のアクセス方法(全表スキャンや索引スキャンなど)および様々な結合方法(ネステッド・ループ結合やハッシュ結合など)を調べることで、SQL文の最適な計画を決定します。
データベースには、自由に使える内部統計およびツールが多数あるため、オプティマイザは通常、文の実行の最適な方法を決める上でユーザーよりも優位な立場にあります。このため、すべてのSQL文でオプティマイザが使用されます。
あるユーザーが、マネージャである従業員のレコードを問い合せる場合を考えてみます。データベース統計で従業員の80%がマネージャであると示されている場合、オプティマイザは、全表スキャンが最も効率的であると判断できます。ただし、統計でマネージャが少ないことが示されている場合、索引を読み取ってからROWIDによる表アクセスを行うほうが全表スキャンよりも効率的なことがあります。
コストベースの最適化
問合せ最適化は、SQL文を実行するための最も効率的な方法を選択する全体的なプロセスです。SQLは非手続き型言語であるため、オプティマイザでマージ、再編成、処理の順序を自由に選択できます。
アクセスするデータに関して収集された統計に基づいて、各SQL文が最適化されます。実行計画が生成される際には、オプティマイザによって様々なアクセス・パスと結合方法が考慮されます。オプティマイザによって考慮される要素には次のようなものがあります。
システム・リソース(I/O、CPU、メモリーなど)
戻される行の数
初期データ・セットのサイズ
コストは、任意の実行計画における、推定のリソース使用率を表す数値です。オプティマイザによって、それぞれの可能な計画にコストが割り当てられ、最もコストの低い計画が選択されます。このため、オプティマイザは、従来のルールベース・オプティマイザ(RBO)との対比で、コストベース・オプティマイザ(CBO)と呼ばれることがあります。
注意:
オプティマイザは、Oracle Databaseのあるバージョンとその次のバージョンで同じ決定を行うとはかぎりません。新しいバージョンのオプティマイザでは、より高度な情報を使用でき、かつより多くのオプティマイザ変換が可能なため、異なる決定が行われる場合があります。
実行計画
実行計画とは、SQL文の推奨実行方法を示したものです。この計画により、SQL文を実行するためにOracle Databaseで使用するステップの組合せが示されます。各処理では、データベースからデータ行を物理的に検索するか、文を発行したユーザーのためにデータ行を準備します。
図4-1では、オプティマイザは、入力SQL文の実行計画として2つの使用可能な計画を生成し、統計を使用してそれらのコストを計算し、コストを比較して、最もコストの低い計画を選択します。
問合せオプティマイザの概念
