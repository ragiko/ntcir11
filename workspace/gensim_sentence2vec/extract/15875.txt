$Date: 2014/11/16 23:19:44 $
概要
LAN分割機能とは、ポートベースVLANを実現する機能です。本機能によって、スイッチングハブを持つLANインタフェースを仮想的に複数のLANインタフェースとして利用することができます。各インタフェースにはそれぞれ個別のIPアドレスを付与でき、その間でのルーティングも可能になります。
LAN分割機能には基本機能と拡張機能があります。両者の違いはLAN (スイッチングハブ) の分割方法にあり、具体的には次のようになります。
基本機能では、スイッチングハブのすべてのポートが個別のLANインタフェースとして動作します。
拡張機能では、スイッチングハブの各ポートを自由に組み合わせて1つのLANインタフェース (VLANインタフェース) とすることができます。同一のVLANインタフェースに所属するポート間はスイッチとして動作します。
拡張機能はRev.10.01系以降のファームウェアに実装されており、Rev.10.00系以前のファームウェアでは基本機能のみ使用することができます。両者では使用するインタフェース名やコマンドが異なるため、ご使用のファームウェアリビジョンに合わせて本ドキュメントをご参照ください。
対応機種とファームウェアリビジョン
各機能の対応機種およびファームウェアは以下の通りとなります。
LAN分割機能 (基本機能)
機種
ファームウェア
SRT100
Rev.10.00.08以降
RTX1500
Rev.8.02.14以降
RTX1100
Rev.8.02.31以降
RTX1000
Rev.8.01.12以降
LAN分割機能 (拡張機能)
機種
ファームウェア
RTX1210
Rev.14.01.05以降
RTX5000
Rev.14.00.08以降
RTX3500
Rev.14.00.08以降
FWX120
Rev.11.03.02以降
RTX810
Rev.11.01.04以降
RTX1200
Rev.10.01.07以降
詳細
ポートベースVLAN
物理的な接続形態に依存せず、仮想的にグループを形成してひとつのLANとみなすものがVLAN (Virtual LAN) です。VLANには様々な種類があります。LAN分割機能はポートベースVLANを実現するものですが、ヤマハルーターはこのほかにタグVLANにも対応しています。タグVLANに関する詳細はこちらをご覧ください。
ポートベースVLANでは、ポート単位でブロードキャストドメイン (ARP要求が到達する範囲) を制御することができます。ポートベースVLANに対応したスイッチングハブを利用すれば、接続されている端末が所属するネットワークを自由に変更できるため、物理的に配線を変更する場合と比べて設定や管理が容易になります。
LAN分割機能の動作
8ポートのスイッチングハブを持つlan1インタフェースを例として、LAN分割機能の動作を説明します。
図の見方
それぞれの図の上部はLANインタフェースを、下部は8ポートのスイッチングハブを表しています。LANインタフェース1つにつきIPアドレスを1つ割り当てることができ、接続されているスイッチングハブでそのIPアドレスを使用することができます。なお、図中のインタフェースの名称については「コマンド」の項目をご参照ください。
LAN分割機能が有効になっていない状態では、スイッチングハブのすべてのポートが同一のLANインタフェースとして動作します。図は、lan1 (ポート1-8) に192.168.1.1/24のIPアドレスを割り当てた状態です。
LAN分割機能の基本機能では、すべてのポートが個別のLANインタフェースとなります。lan1.1-lan1.8というインタフェースが、それぞれスイッチングハブのポート1-8に対応します。
LAN分割機能の拡張機能ではvlan1-vlan8というインタフェース (VLANインタフェース) を使用します。基本機能とは異なり、これらのインタフェースはスイッチングハブの特定のポートに関連付けられていません。各ポートがどのVLANインタフェースに所属するかをユーザーが設定することで、分割方法を自由に変更することができます。図は、ポート1-3をvlan2に、ポート4-6をvlan5に、ポート7をvlan7に、ポート8をvlan8に、それぞれ所属させた状態です。同一のVLANインタフェースに所属するポート間はスイッチとして動作します。
ポート分離機能との違い
LAN分割機能と混同されやすい機能としてポート分離機能があります。ここでは両者の違いを解説します。なお、分離パターンの記述法については「コマンド」の項目をご参照ください。
下図は、ポート分離機能を使ってlan1のスイッチングハブを123:456:7:8に分離した状態を表しています。LAN分割機能とは異なり、ポート分離機能ではスイッチのポートを分離してもLANインタフェースは分割されないため、ポート1-8はすべて同一ネットワークに所属し、192.168.1.1/24のIPアドレスが割り当てられたlan1として動作します。
ルーターが受信したパケットの宛先ネットワークが自身のネットワークアドレスと一致する場合、そのパケットはスイッチングハブのポート間で直接転送されます。例えば、ポート3に接続された端末A (192.168.1.30/24) が192.168.2.30/24宛にパケットを送った場合、そのパケットはスイッチからlan1へ転送されますが、ポート4に接続された端末B (192.168.1.40/24) 宛に送った場合は、lan1を経由することなくポート3からポート4へ直接転送されます。
ポート分離機能で分離されたポート間では、直接パケットを転送することが禁止されます。
例えば、上図のポート3に接続された端末A (192.168.1.30/24) がポート4に接続された端末B (192.168.1.40/24) 宛に送ったパケットはポート間で直接転送されないため、ルーターを経由することなしには端末AとBの間で通信を行うことができません。
以上のようにポート分離機能は、スイッチングハブに接続されている端末間の通信は制限したいが、ネットワーク構成は変更したくないという場合に利用されます。
コマンド
LANインタフェースの動作タイプの設定
[書式]
lan type interface_with_swhub speed [port] [speed [port]...] [option=value...]
lan type interface_with_swhub option=value [option=value]
lan type interface_without_swhub speed [option=value...]
lan type interface_without_swhub option=value [option=value]
no lan type interface [...]
[設定値]
interface_with_swhub ... スイッチングハブを持つLANインタフェース名
interface_without_swhub ... スイッチングハブを持たないLANインタフェース名
interface ... LANインタフェース名
speed ... LAN速度および動作モード
auto ... 速度自動判別
1000-fdx ... 1000BASE-T全二重
100-fdx ... 100BASE-TX全二重
100-hdx ... 100BASE-TX半二重
10-fdx ... 10BASE-T全二重
10-hdx ... 10BASE-T半二重
省略時はauto
port ... スイッチングハブのポート番号
省略時は全ポート
option=value ... オプション機能
mtu ... インタフェースで送受信できる最大データ長
auto-crossover ... オートクロスオーバー機能
on ... オートクロスオーバー機能を有効にする
off ... オートクロスオーバー機能を無効にする
speed-downshift ... 速度ダウンシフト機能
on ... 速度ダウンシフト機能を有効にする
off ... 速度ダウンシフト機能を無効にする
macaddress-aging ... MACアドレスエージング機能
秒数 ... エージング時間
on ... MACアドレスエージング機能を有効にする
off ... MACアドレスエージング機能を無効にする
port-based-ks8995m/port-based-option ... LAN分割機能、ポート分離機能
divide-network ... LAN分割機能を有効にする
split-into-split_pattern ... ポート分離機能を有効にする
off ... LAN分割機能、ポート分離機能を無効にする
[説明]
指定したLANインタフェースの速度と動作モードの種類、およびオプション機能について設定する。
スイッチングハブを持つLANインタフェースについては、ポート毎に速度と動作モードを指定できる。
"port-based-ks8995m/port-based-option" を設定する場合、コマンド文字列として、Rev.10.00 系以前のファームウェアでは "port-based-ks8995m" を、Rev.10.01 系以降のファームウェアでは "port-based-option" を入力する。Rev.10.01以降のファームウェアでも "port-based-ks8995m" を入力することはできるが、show configの出力には "port-based-option" と表示される。
mtu
インタフェースで送受信できる最大データ長を指定する。データ長にはMACヘッダとFCSは含まれない。また、タグVLAN時のタグ長 (4バイト) も含まれない。
指定できるデータ長の範囲はLANインタフェースによって異なる。ジャンボフレームをサポートしていないLANインタフェースでは、64〜1500の範囲となる。ジャンボフレームをサポートしているLANインタフェースでは、以下のようになる。
機種
インタフェース
設定範囲
RTX5000、RTX3500
LAN1、LAN2、LAN3、LAN4
64〜9578
RTX3000
LAN1、LAN2
64〜9578
インタフェースのmtuを設定して、かつ、ip mtuコマンドまたはipv6 mtuコマンドが設定されずデフォルトのままの場合、IPv4やIPv6でのmtuとしてはインタフェースのmtuが利用される。一方、ip mtuコマンドまたはipv6 mtuコマンドが設定されている場合には、インタフェースのmtuの設定にかかわらず、ip mtuコマンドまたはipv6 mtuコマンドの設定値がmtuとして利用される。インタフェースのmtuも含めてすべて設定されていない時には、デフォルト値である1500が利用される。
オートクロスオーバー機能
LANケーブルがストレートケーブルかクロスケーブルかを自動的に判定して接続する機能。この機能が有効になっていると、ケーブルのタイプがどのようなものであるかを気にする必要が無くなる。
このオプションはRTX2000、RT300iでは利用できない。
速度ダウンシフト機能
Rev.10.01以降のファームウェアで、1000BASE-Tのインタフェースを持つ機種で利用できる。
例えば1000BASE-Tで使用できないケーブルを接続された時に、速度を落としてリンクを試みる機能である。
MACアドレスエージング機能
スイッチングハブを持つLANインタフェースでのみ利用できる。
スイッチングハブが持つMACアドレステーブル内のエントリを、一定時間で消去していく機能。この機能をoffにすると、一度スイッチングハブが記憶したMACアドレスは自動的に消去されないのはもちろん、clear switching-hub macaddressコマンドを実行しても消去されない。エントリが消去されるのは、この機能をonに設定し直した時だけになる。
以下の機種では設定値に秒数を指定することができる。ただし、コマンドの設定値と実際に消去されるまでの時間に誤差が生じる場合がある。
機種
設定範囲
RTX5000、RTX3500
1〜3825
RTX1210
10〜630
RTX1200
1〜86400
RTX810、FWX120
1〜3551
秒数を指定できる機種でonを入力すると初期値である300に変換される。
MACアドレステーブルの大きさは以下の通りとなる。
機種
最大エントリ数
RTX5000、RTX3500、RTX1210、RTX1200
8192
RTX1500、RTX1100、RTX1000、RTX810、RT107e、FWX120、SRT100
1024
LAN分割機能
スイッチングハブを持つLANインタフェースでのみ利用できる。
このオプションはRT107eでは利用できない。
LAN分割機能には基本機能と拡張機能があり、拡張機能はRev.10.01系以降のファームウェアで利用できる。
基本機能では、スイッチングハブの各ポートが個別のLANインタフェースとして動作する。各インタフェースにはそれぞれ個別のIPアドレスを付与でき、その間でのルーティグも可能になる。例えばRTX1100は通常はLANインタフェースを3つ持つルーターなのだが、LAN分割機能を使えばLANインタフェースを6個利用できることになる。
拡張機能では、スイッチングハブの各ポートを自由に組み合わせて1つのLANインタフェース (VLANインタフェース) とすることができる。同一のVLANインタフェースに所属するポート間はスイッチとして動作する。
LAN分割で使用するインタフェース名は基本機能と拡張機能で異なる。
基本機能におけるLANインタフェースのインタフェース名は元のLANインタフェース名にピリオドとポート番号をつなげることで表される。例えば、RTX1100はlan1が4ポートのスイッチングハブを持つLANインタフェースなので、以下のLANインタフェースが使用できるようになる。
ポート番号
インタフェース名
1
lan1.1
2
lan1.2
3
lan1.3
4
lan1.4
拡張機能では、LANインタフェースのインタフェース名としてvlan1、vlan2、vlan3・・・ (VLANインタフェース) を使用する。基本機能とは異なり、VLANインタフェースは特定のポートと関連付けられてはいない。vlan port mappingコマンドを用いて、スイッチングハブの各ポートがどのVLANインタフェースに所属するかを設定することで、分割方法を自由に変更することができる。
同時にいくつのVLANインタフェースを使用できるかは機種ごとに異なり、以下の通りとなる。
機種
設定できるVLANインタフェース
RTX5000、RTX3500
vlan1-vlan4 (LAN1)、vlan5-vlan8 (LAN2)
RTX1210、RTX1200
vlan1-vlan8
RTX810、FWX120
vlan1-vlan4
LAN分割機能を有効にした場合、lan1インタフェースに対する設定は、lan1.1 (基本機能の場合) もしくは vlan1 (拡張機能の場合) に引き継がれる。
LAN分割で使用するLANインタフェースのMACアドレスは元のLANインタフェースのMACアドレスに一致する。したがって上記の例では、lan1.1-lan1.4やvlan1-vlan4のMACアドレスはすべてlan1と同一になる。
ポート分離機能
Rev.8.03.24以降のファームウェアで、スイッチングハブを持つLANインタフェースでのみ利用できる。
スイッチングハブのポート間での通信を禁止しつつ、ルーターを経由した通信は可能にする機能。
通常はスイッチングハブの各ポートは他のポートと制限無く通信できるが、ポート分離機能を利用すると、ポートをグループに分離し、グループ内の通信およびルーターとの通信はそのまま可能だけれども、他のグループのポートとは通信できないようになる。
LAN分割機能とは異なり、ポート分離機能によってLANインタフェースが増減することはない。分離されたポートはすべて同じLANインタフェースとして認識され、同一のIPアドレスを持つ。
ポートの分離パターンは、ポート番号の数字の並びで分離する部分に ":" を入れて記述する。例を以下に示す。
スイッチングハブのポート数が4の場合
split_pattern
ポート
説明
1
2
3
4
1:234
<-->
<-------->
ポート1とその他
1:2:34
<-->
<-->
<------>
ポート1、ポート2とその他
1:2:3:4
<-->
<-->
<-->
<-->
全ポートを分離
スイッチングハブのポート数が8の場合
最後のグループの記述を省略することができる。以下の表では、省略形を括弧内に示す。
split_pattern
ポート
説明
1
2
3
4
5
6
7
8
123:45678 (123)
<-------->
<------------>
ポート1-3とその他
1:234:5678 (1:234)
<-->
<-------->
<---------->
ポート1とポート2-4とその他
12:34:56:78 (12:34:56)
<------>
<------>
<------>
<------>
ポート1、2、ポート3、4、ポート5、6とその他
1:2:3:4:5:6:7:8 (1:2:3:4:5:6:7)
<-->
<-->
<-->
<-->
<-->
<-->
<-->
<-->
全ポートを分離
省略形でコマンドを入力しても、show configの出力には省略しない形で表示される。
同一LANインタフェースにおけるプライマリアドレスのネットワークとセカンダリアドレスのネットワーク間の通信はルーターを経由するので、他のグループとの通信も可能である。
[ノート]
本コマンドの実行後、LANインタフェースのリセットが自動で行われ、その後に設定が有効となる。
[初期値]
speed=auto
mtu=1500
auto-crossover=on
speed-downshift=on
macaddress-aging=on (秒数を指定できない機種)
macaddress-aging=300 (秒数を指定できる機種)
port-based-ks8995m/port-based-option=off
[設定例]
スイッチングハブを持つLANインタフェースで、ポート1、2は100BASE-TX全二重、その他のポートはオートネゴシエーションで接続する。
# lan type lan1 100-fdx 1 2
スイッチングハブを持つLANインタフェースで、ポート1は100BASE-TX全二重、その他のポートはオートネゴシエーションで接続する。LAN分割機能を使用する。
Rev.10.00 系以前のファームウェアの場合
# lan type lan1 100-fdx 1 port-based-ks8995m=divide-network
Rev.10.01 系以降のファームウェアの場合
# lan type lan1 100-fdx 1 port-based-option=divide-network
スイッチングハブを持つLANインタフェースで、すべてのポートでオートネゴシエーションで接続する。ポート分離機能でポートを分離する。
Rev.10.00 系以前のファームウェアで、4つのポートを持つスイッチングハブの1、2と3、4を分離する場合
# lan type lan1 port-based-ks8995m=split-into-12:34
Rev.10.01 系以降のファームウェアで、8つのポートを持つスイッチングハブの1、2、3と4、5、6とその他を分離する場合
# lan type lan1 port-based-option=split-into-123:456:78
[分離パターンを省略して記述する場合]
# lan type lan1 port-based-option=split-into-123:456
LAN1で、ジャンボフレーム (9000バイト) を使用できるようにする。
# lan type lan1 auto mtu=9000
[適用モデル]
RTX5000
RTX3500
RTX3000
RTX2000
RTX1500
RTX1210
RTX1200
RTX1100
RTX1000
RTX810
RT300i
RT250i
RT107e
FWX120
SRT100
スイッチングハブのポートが所属するVLANの設定
[書式]
vlan port mapping sw_port vlan_interface
no vlan port mapping sw_port [vlan_interface...]
[設定値]
sw_port ... スイッチングハブのポート (lan1.N)
vlan_interface ... VLANインタフェース (vlanN)
[説明]
LAN分割機能の拡張機能において、スイッチングハブの各ポートが所属するVLANインタフェースを指定する。ポートの名称には lan1.N / lan2.N を使用する。lan2.N はスイッチインタフェースが 2 個ある機種で指定可能である。同一のVLANインタフェースに所属するポート間はスイッチとして動作する。
RTX5000、RTX3500 では、lan1.N のポートに対して vlan1 〜 vlan4 をマッピングすることができ、lan2.N のポートに対しては vlan5 〜 vlan8 をマッピングすることができる。
[ノート]
lan typeコマンドで "port-based-option=divide-network" を設定し、LAN分割機能を有効にしなければ本コマンドは機能しない。"port-based-option=divide-network" の設定が無い場合でもvlan port mappingは設定できるが、スイッチングハブの動作は変化しない。
[初期値]
スイッチインタフェースが 1 個の機種の初期状態のマッピングは、lan1.N = vlanN となる。
[設定例]
# vlan port mapping lan1.3 vlan7
# vlan port mapping lan1.4 vlan7
[適用モデル]
RTX5000
RTX3500
RTX3000
RTX2000
RTX1500
RTX1210
RTX1200
RTX1100
RTX1000
RTX810
RT300i
RT250i
RT107e
FWX120
SRT100
制限事項
show status interfaceコマンドで、lan1.NやvlanNをinterfaceに指定することはできません。
同一LANインタフェースでLAN分割機能とタグVLAN機能を併用することはできません。両者 ("lan type interface port-based-option=divide-network" と "vlan interface 802.1q vid=") のうち先に入力されたものが有効となり、後から入力されるものはコマンドエラーになります。
設定例
LAN分割機能の基本機能と拡張機能、それぞれを用いた設定例を解説します。
基本機能を用いた設定
基本機能を用いて以下のような設定を行います
インタフェース
IPアドレス
lan1.3
192.168.3.1/24
lan1.4
192.168.4.1/24
lan1インタフェースに対してLAN分割機能を有効にします。
# lan type lan1 port-based-ks8995m=divide-network
スイッチングハブの各ポートが個別のLANインタフェースとなります。
各LANインタフェースに対して、IPアドレスを割り当てます。
# ip lan1.3 address 192.168.3.1/24
# ip lan1.4 address 192.168.4.1/24
拡張機能を用いた設定
拡張機能を用いて以下のような設定を行います。
インタフェース
所属するスイッチポート
IPアドレス
vlan1
lan1.1 lan1.2
192.168.10.1/24
vlan2
lan1.3 lan1.4 lan1.7
192.168.20.1/24
vlan3
lan1.5 lan1.6 lan1.8
192.168.30.1/24
lan1インタフェースに対してLAN分割機能を有効にします。
# lan type lan1 port-based-option=divide-network
スイッチングハブのポート毎に所属するVLANインタフェースを指定します。設定値が初期値と同様の場合は入力しなくても構いません。
# vlan port mapping lan1.1 vlan1
# vlan port mapping lan1.2 vlan1
# vlan port mapping lan1.3 vlan2
# vlan port mapping lan1.4 vlan2
# vlan port mapping lan1.5 vlan3
# vlan port mapping lan1.6 vlan3
# vlan port mapping lan1.7 vlan2
# vlan port mapping lan1.8 vlan3
各VLANインタフェースに対して、IPアドレスを割り当てます。
# ip vlan1 address 192.168.10.1/24
# ip vlan2 address 192.168.20.1/24
# ip vlan3 address 192.168.30.1/24
基本機能と拡張機能におけるConfigの互換性について
基本機能と拡張機能ではインタフェース名やコマンドが異なりますが、基本機能で作成したConfigを修正せずにそのまま拡張機能で活用することができます。この仕組みは、例えばRTX1100からRTX1200に移行する場合などに役立ちます。
LAN分割機能で使用するLANインタフェース名は、基本機能ではlan1.N、拡張機能ではvlanNとなります。拡張機能において、lan1.Nはスイッチングハブのポートを指す名称として用いられるため、vlan port mappingコマンド以外で使用することは推奨されません。
拡張機能でlan1.Nを用いたコマンドを入力した場合には、vlan port mappingコマンドの設定に従ってインタフェース名がlan1.NからvlanNに変換されます。例えば、Rev.10.00系以前のファームウェアでConfig1が設定されているとします。
Config1 (Rev.10.00系以前)
# lan type lan1 port-based-ks8995m=divide-network
# ip lan1.3 address 192.168.10.1/24
# ip lan1.3 nat descriptor 1
# ip lan1.4 address 192.168.20.1/24
# telnetd host lan1.4
# httpd host lan1.2
次に、Rev.10.01系以降のファームウェアでConfig2が設定されているとします。
Config2 (Rev.10.01系以降)
# vlan port mapping lan1.2 vlan5
# vlan port mapping lan1.3 vlan2
# vlan port mapping lan1.4 vlan5
# lan type lan1 port-based-option=divide-network
Config2が設定されている状態でConfig1を追加で入力すると、lan1.2とlan1.4がvlan5、lan1.3がvlan2に変換されてConfig3のようになります ("port-based-ks8995m" は "port-based-option" に変換されます) 。
Config3 (Rev.10.01系以降)
# vlan port mapping lan1.2 vlan5
# vlan port mapping lan1.3 vlan2
# vlan port mapping lan1.4 vlan5
# lan type lan1 port-based-option=divide-network
# ip vlan2 address 192.168.10.1/24
# ip vlan2 nat descriptor 1
# ip vlan5 address 192.168.20.1/24
# telnetd host vlan5
# httpd host vlan5
この仕組みを用いることで、Configを書き換えることなく基本機能から拡張機能へ移行することができます。Config3において、vlan port mappingの設定がない (初期値である) 場合はConfig4のように変換されます。
Config4 (Rev.10.01系以降)
# lan type lan1 port-based-option=divide-network
# ip vlan3 address 192.168.10.1/24
# ip vlan3 nat descriptor 1
# ip vlan4 address 192.168.20.1/24
# telnetd host vlan4
# httpd host vlan2
vlan2にはlan1.2のみ、vlan3にはlan1.3のみ、vlan4にはlan1.4のみが所属しているため、ルーターの動作としては基本機能の場合と同様になります。
LAN分割機能
