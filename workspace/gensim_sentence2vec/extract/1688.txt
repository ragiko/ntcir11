バックアップ前のデータベース・ファイルの表示
データベースのデータファイルおよび制御ファイルを確認するには、V$DATAFILEおよびV$CONTROLFILEビューを使用します。次に示す手順は、これらのファイルの名前を手動で付けた場合も、Oracle Managed Filesで付けた場合も、同様に使用できます。
データファイルおよび制御ファイルを表示する手順
SQL*Plusを起動し、V$DATAFILEを問い合せてデータファイルのリストを取得します。たとえば、次のように入力します。
SELECT NAME FROM V$DATAFILE;
V$TABLESPACEビューとV$DATAFILEビューを結合して、データファイルのリストと、関連する表領域のリストを取得することもできます。
SELECT   t.NAME "Tablespace", f.NAME "Datafile"
FROM     V$TABLESPACE t, V$DATAFILE f
WHERE    t.TS# = f.TS#
ORDER BY t.NAME;
V$CONTROLFILEビューを問い合せて、現行の制御ファイルのファイル名を取得します。たとえば、次の問合せを発行します。
SELECT NAME FROM V$CONTROLFILE;
多重制御ファイルの場合は、バックアップする必要があるのは1つのコピーのみです。
ALTER DATABASE BACKUP CONTROLFILE TO 'filename'文を使用して制御ファイルのバックアップを実行する場合には、制御ファイルのバックアップとともに、すべてのデータファイルおよびオンラインREDOログ・ファイルのリストを保存します。現在のデータベース構造は、制御ファイルの特定のバックアップが作成された時点のデータベース構造とは異なる場合があるため、バックアップ制御ファイルに記録されたファイルのリストを保存しておくと、リカバリを行う際に便利です。
オンライン表領域バックアップのデータファイルのステータスの確認
データファイルが現行のオンライン表領域のバックアップの一部であるかどうかを確認するには、V$BACKUPビューを問い合せます。
このビューはユーザー管理のオンライン表領域バックアップでのみ有効です。RMANのバックアップおよびオフライン表領域のバックアップでは、表領域のデータファイルをバックアップ・モードに設定する必要がないためです。 一部のユーザー管理バックアップ手順では、分裂ブロックの発生を防ぐため、表領域をバックアップ・モードにする必要があります。ただし、バックアップ・モードでは、データベースへの更新によって通常より多くのREDOが作成されます。
V$BACKUPビューは、データベースがオープンしている場合に特に有効です。また、障害時のファイルのバックアップ・ステータスも表示されるため、インスタンス障害の直後にも有効です。この情報を使用して、バックアップ・モードのままになっている表領域があるかどうかを確認します。
現在使用されている制御ファイルが、リストアされたバックアップか、メディア障害の発生後に作成された新しい制御ファイルの場合には、V$BACKUPは役に立ちません。リストアされた制御ファイルまたは再作成された制御ファイルには、データベースがV$BACKUPを正確に移入するために必要とする情報が含まれていません。また、ファイルのバックアップをリストアした場合には、V$BACKUPの中のこのファイルのSTATUSは、最新のバージョンではなく、ファイルの古いバージョンのバックアップ・ステータスを反映したものになります。このため、このビューにはリストアされたファイルに関して誤解を招くデータが表示される場合があります。
たとえば、次の問合せを実行して、バックアップ・モードに設定された表領域に現在どのようなデータファイルが含まれているかを表示するとします。
SELECT t.name AS "TB_NAME", d.file# as "DF#", d.name AS "DF_NAME", b.status
FROM   V$DATAFILE d, V$TABLESPACE t, V$BACKUP b
WHERE  d.TS#=t.TS#
AND    b.FILE#=d.FILE#
AND    b.STATUS='ACTIVE';
次の出力例は、toolsおよびusers表領域が現在ACTIVEステータスであることを示しています。
TB_NAME                 DF#        DF_NAME                           STATUS
----------------------  ---------- --------------------------------  ------
TOOLS                   7          /oracle/oradata/trgt/tools01.dbf  ACTIVE
USERS                   8          /oracle/oradata/trgt/users01.dbf  ACTIVE
STATUS列にNOT ACTIVEが表示されている場合、ファイルが現在バックアップ・モードではない(ALTER TABLESPACE ... BEGIN BACKUPまたはALTER DATABASE BEGIN BACKUP文を実行していない)ことを意味します。ACTIVEが表示されている場合、ファイルが現在バックアップ・モードであることを意味します。
データベース全体のユーザー管理バックアップの作成
NORMAL、IMMEDIATEまたはTRANSACTIONALオプションを使用してデータベースを停止した後で、データベース全体のバックアップを実行し、データベース内のすべてのファイルのバックアップを作成できます。データベースのオープン中、またはインスタンス障害やSHUTDOWN ABORTコマンドの後に作成されたデータベース全体のバックアップは一貫性のないものになります。この場合のファイルは、データベース・チェックポイントSCNと一貫性がありません。
データベースをARCHIVELOGモードまたはNOARCHIVELOGモードのどちらで実行していても、データベース全体のバックアップを作成できます。ただし、データベースをNOARCHIVELOGモードで実行する場合は、バックアップ前にデータベースを正しく停止して、一貫性のあるバックアップを作成する必要があります。
一貫性のあるデータベース全体のバックアップによって作成されたバックアップ・ファイルのセットでは、すべてのファイルで同じSCNにチェックポイントが設定されているため、一貫性があります。一貫性のあるデータベースのバックアップは、リカバリを実行せずにリストアできます。データベースをARCHIVELOGモードで実行している場合は、バックアップ・ファイルをリストアした後で、追加のリカバリ手順を実行してデータベースをより新しい時点までリカバリできます。また、データベースがARCHIVELOGモードの場合には、一貫性のないデータベース全体のバックアップを作成することもできます。
制御ファイルは、データベースのリストアおよびリカバリに重要な役割を果たします。ARCHIVELOGモードで実行しているデータベースの場合には、ALTER DATABASE BACKUP CONTROLFILE TO 'filename'文を使用して、制御ファイルをバックアップしておくことをお薦めします。
一貫性のあるデータベース全体のバックアップの作成
この項では、オペレーティング・システム・ユーティリティを使用してデータベースをバックアップする方法を説明します。
一貫性のあるデータベース全体のバックアップを作成する手順
データベースがオープンしている場合は、SQL*Plusを使用して、NORMAL、IMMEDIATEまたはTRANSACTIONALオプションを指定してデータベースを停止します。
オペレーティング・システム・ユーティリティを使用して、すべてのデータファイルと、初期化パラメータ・ファイルのCONTROL_FILESパラメータで指定されたすべての制御ファイルのバックアップを作成します。また、初期化パラメータ・ファイルおよびその他のOracle製品の初期化ファイルもバックアップします。これらのファイルを検索するには、*.oraを使用して、Oracleホーム・ディレクトリから開始してすべてのサブディレクトリを再帰的に検索します。
たとえば、次に示すとおり、データファイル、制御ファイルおよびアーカイブ・ログを/disk2/backupにバックアップできます。
% cp $ORACLE_HOME/oradata/trgt/*.dbf /disk2/backup
% cp $ORACLE_HOME/oradata/trgt/arch/* /disk2/backup/arch
SQL*PlusでSTARTUPコマンドを使用して、データベースを再起動します。
ユーザー管理データベース・バックアップの作成
